<template>
	<view class="container">
		<view class="header">
			<text class="title">ğŸ‘¤ æˆ‘çš„</text>
		</view>
		<!-- å¤´åƒä¸ç™»å½• -->
		<view class="profile-section">
			<view class="avatar-wrapper">
				<image class="avatar" :src="avatarUrl" mode="aspectFill"></image>
			</view>
			<!-- æœªç™»å½•æ—¶æ˜¾ç¤ºç™»å½•æŒ‰é’® -->
			<view class="auth-button" v-if="!isLoggedIn" @click="openAuthDialog">
				<text class="auth-button-text">æ³¨å†Œ / ç™»é™†</text>
			</view>
			<!-- å·²ç™»å½•æ—¶æ˜¾ç¤ºæ‰‹æœºå· -->
			<view class="phone-number" v-if="isLoggedIn">
				<text class="phone-number-text">{{ authPhoneNumber }}</text>
			</view>
		</view>
		<view class="content">
			<view class="menu-list">
				<view class="menu-item" @click="handleMenuClick('æ¡£æ¡ˆ')">
					<text class="menu-icon">ğŸ“</text>
					<text class="menu-text">æ¡£æ¡ˆ</text>
				</view>
				<view class="menu-item" @click="handleMenuClick('å·¥å…·')">
					<text class="menu-icon">ğŸ”§</text>
					<text class="menu-text">å·¥å…·</text>
				</view>
				<view class="menu-item" @click="handleMenuClick('èµ„æº')">
					<text class="menu-icon">ğŸ“¦</text>
					<text class="menu-text">èµ„æº</text>
				</view>
				<view class="menu-item" @click="handleMenuClick('å¹¿å‘Š')">
					<text class="menu-icon">ğŸ“¢</text>
					<text class="menu-text">å¹¿å‘Š</text>
				</view>
				<view class="menu-item" @click="handleMenuClick('æèµ ')">
					<text class="menu-icon">ğŸ’</text>
					<text class="menu-text">æèµ </text>
				</view>
			</view>
		</view>
		
		<!-- é€€å‡ºè´¦å·æŒ‰é’® -->
		<view class="logout-section" v-if="isLoggedIn">
			<view class="logout-button" @click="handleLogout">
				<text class="logout-button-text">é€€å‡ºè´¦å·</text>
			</view>
		</view>

		<!-- æ³¨å†Œ/ç™»é™†å¼¹çª— -->
		<view class="dialog-mask" v-if="showAuthDialog" @click="closeAuthDialog">
			<view class="auth-dialog" @click.stop>
				<view class="auth-dialog-header">
					<text class="auth-dialog-title">æ³¨å†Œ / ç™»é™†</text>
					<view class="dialog-close" @click="closeAuthDialog">
						<text class="close-icon">âœ•</text>
					</view>
				</view>
				<view class="auth-dialog-content">
					<input class="auth-input" v-model="phoneNumber" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
					<input class="auth-input" v-model="password" placeholder="è¯·è¾“å…¥å¯†ç " password />
					<view class="dialog-actions">
						<view class="dialog-button confirm-button" @click="submitAuth">
							<text class="dialog-button-text">ç¡®è®¤</text>
						</view>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { login } from '../../utils/api.uts'
	export default {
		data() {
			return {
				avatarUrl: 'https://qiniu-web-assets.dcloud.net.cn/unidoc/zh/unicloudlogo.png',
				showAuthDialog: false,
				phoneNumber: '',
				password: '',
				authToken: '',
				authPhoneNumber: ''
			}
		},
		computed: {
			isLoggedIn(): boolean {
				return this.authToken != null && this.authToken != '' && this.authPhoneNumber != null && this.authPhoneNumber != ''
			}
		},
		onLoad() {
			this.loadAuthInfo()
		},
		methods: {
			openAuthDialog() {
				this.showAuthDialog = true
			},
			closeAuthDialog() {
				this.showAuthDialog = false
			},
			submitAuth() {
				const name = this.phoneNumber.trim()
				const pwd = this.password.trim()
				if (name === '' || pwd === '') {
					uni.showToast({
						title: 'è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ',
						icon: 'none'
					})
					return
				}
				uni.showLoading({
					title: 'ç™»é™†ä¸­...',
					mask: true
				})
				
				login(name, pwd, (res: any) => {
					uni.hideLoading()
					if (res.success) {
						this.authToken = res.token
						this.authPhoneNumber = name
						try {
							uni.setStorageSync('authToken', res.token)
							uni.setStorageSync('authPhoneNumber', name)
						} catch (e) {
							console.error('ä¿å­˜tokenå¤±è´¥:', e)
						}
						uni.showToast({
							title: res.message || 'ç™»å½•æˆåŠŸ',
							icon: 'success'
						})
						this.closeAuthDialog()
						// æ¸…ç©ºè¾“å…¥æ¡†
						this.phoneNumber = ''
						this.password = ''
					} else {
						uni.showToast({
							title: res.message || 'ç™»å½•å¤±è´¥',
							icon: 'none'
						})
					}
				})
			},
			loadAuthInfo() {
				try {
					const token = uni.getStorageSync('authToken')
					const phone = uni.getStorageSync('authPhoneNumber')
					if (token != null && token != '' && phone != null && phone != '') {
						this.authToken = token.toString()
						this.authPhoneNumber = phone.toString()
					}
				} catch (e) {
					console.error('åŠ è½½ç™»å½•ä¿¡æ¯å¤±è´¥:', e)
				}
			},
			handleLogout() {
				uni.showModal({
					title: 'æç¤º',
					content: 'ç¡®å®šè¦é€€å‡ºè´¦å·å—ï¼Ÿ',
					success: (res: any) => {
						if (res.confirm) {
							this.authToken = ''
							this.authPhoneNumber = ''
							try {
								uni.removeStorageSync('authToken')
								uni.removeStorageSync('authPhoneNumber')
							} catch (e) {
								console.error('æ¸…é™¤ç™»å½•ä¿¡æ¯å¤±è´¥:', e)
							}
							uni.showToast({
								title: 'å·²é€€å‡ºè´¦å·',
								icon: 'success'
							})
						}
					}
				})
			},
			handleMenuClick(menuName: string) {
				// æ ¹æ®èœå•åç§°æ‰§è¡Œç›¸åº”æ“ä½œ
				switch (menuName) {
					case 'æ¡£æ¡ˆ':
						uni.showToast({
							title: 'æ¡£æ¡ˆåŠŸèƒ½å¼€å‘ä¸­',
							icon: 'none',
							duration: 2000
						})
						break
					case 'å·¥å…·':
						uni.navigateTo({
							url: '/pages/mine/tools/tools'
						})
						break
					case 'èµ„æº':
						uni.showToast({
							title: 'èµ„æºåŠŸèƒ½å¼€å‘ä¸­',
							icon: 'none',
							duration: 2000
						})
						break
					case 'å¹¿å‘Š':
						uni.showToast({
							title: 'å¹¿å‘ŠåŠŸèƒ½å¼€å‘ä¸­',
							icon: 'none',
							duration: 2000
						})
						break
					case 'æèµ ':
						uni.showToast({
							title: 'æèµ åŠŸèƒ½å¼€å‘ä¸­',
							icon: 'none',
							duration: 2000
						})
						break
					default:
						break
				}
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #FFB5E8;
		padding: 20px;
	}
	
	.header {
		margin-top: 40px;
		margin-bottom: 30px;
	}
	
	.profile-section {
		align-items: center;
		margin-bottom: 20px;
	}
	
	.avatar-wrapper {
		width: 120px;
		height: 120px;
		border-radius: 60px;
		overflow: hidden;
		border: 4px solid #FFFFFF;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		margin-bottom: 12px;
		background-color: #FFFFFF;
	}
	
	.avatar {
		width: 100%;
		height: 100%;
	}
	
	.auth-button {
		padding: 10px 20px;
		background-color: #F368E0;
		border-radius: 20px;
		border: 2px solid #FFFFFF;
		box-shadow: 0 3px 10px rgba(243, 104, 224, 0.25);
	}
	
	.auth-button:active {
		opacity: 0.9;
	}
	
	.auth-button-text {
		font-size: 16px;
		color: #FFFFFF;
		font-weight: bold;
	}
	
	.phone-number {
		margin-top: 8px;
		padding: 8px 16px;
		background-color: #FFFFFF;
		border-radius: 20px;
		border: 2px solid #F368E0;
	}
	
	.phone-number-text {
		font-size: 16px;
		color: #F368E0;
		font-weight: bold;
	}
	
	.title {
		font-size: 32px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #F368E0;
		padding: 8px 16px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}
	
	.content {
		flex: 1;
		padding: 20px;
	}
	
	.menu-list {
		width: 100%;
		align-items: center;
	}
	
	.menu-item {
		width: 100%;
		height: 70px;
		background-color: #FFFFFF;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 8px;
		border-bottom-color: #E0E0E0;
		margin-bottom: 15px;
		flex-direction: row;
		align-items: center;
		justify-content: center;
	}
	
	.menu-item:active {
		background-color: #F5F5F5;
		border-bottom-width: 4px;
	}
	
	.menu-icon {
		font-size: 28px;
		margin-right: 15px;
	}
	
	.menu-text {
		font-size: 20px;
		font-weight: bold;
		color: #F368E0;
	}

	/* å¼¹çª—æ ·å¼ */
	.dialog-mask {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0, 0, 0, 0.5);
		align-items: center;
		justify-content: center;
		z-index: 999;
	}
	
	.auth-dialog {
		width: 90%;
		max-width: 480px;
		background-color: #FFFFFF;
		border-radius: 16px;
		overflow: hidden;
	}
	
	.auth-dialog-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		padding: 16px 18px;
		border-bottom-width: 1px;
		border-bottom-color: #F0F0F0;
		border-bottom-style: solid;
	}
	
	.auth-dialog-title {
		font-size: 18px;
		font-weight: bold;
		color: #333333;
	}
	
	.dialog-close {
		width: 30px;
		height: 30px;
		align-items: center;
		justify-content: center;
	}
	
	.close-icon {
		font-size: 18px;
		color: #999999;
	}
	
	.auth-dialog-content {
		padding: 18px;
	}
	
	.auth-input {
		width: 100%;
		height: 44px;
		border-width: 1px;
		border-color: #E0E0E0;
		border-style: solid;
		border-radius: 10px;
		padding: 10px 12px;
		font-size: 14px;
		color: #333333;
		margin-bottom: 12px;
		background-color: #FAFAFA;
	}
	
	.dialog-actions {
		margin-top: 10px;
	}
	
	.dialog-button {
		width: 100%;
		background-color: #F368E0;
		border-radius: 10px;
		padding: 12px 0;
		align-items: center;
		justify-content: center;
	}
	
	.dialog-button:active {
		background-color: #e35acb;
	}
	
	.dialog-button-text {
		font-size: 16px;
		color: #FFFFFF;
		font-weight: bold;
	}
	
	/* é€€å‡ºè´¦å·æŒ‰é’®æ ·å¼ */
	.logout-section {
		width: 100%;
		padding: 20px;
		align-items: center;
	}
	
	.logout-button {
		width: 100%;
		padding: 12px 20px;
		background-color: #FF6B6B;
		border-radius: 20px;
		border: 2px solid #FFFFFF;
		box-shadow: 0 3px 10px rgba(255, 107, 107, 0.25);
		align-items: center;
		justify-content: center;
	}
	
	.logout-button:active {
		opacity: 0.9;
		background-color: #ff5252;
	}
	
	.logout-button-text {
		font-size: 16px;
		color: #FFFFFF;
		font-weight: bold;
	}
</style>
