<template>
	<view class="container">
		<view class="header">
			<view class="back-button" @click="goBack">
				<text class="back-icon">â†</text>
			</view>
			<text class="title">ğŸ”§ å·¥å…·</text>
		</view>
		
		<view class="content">
			<view 
				class="tool-card" 
				v-for="(tool, index) in tools" 
				:key="tool.id"
				:class="{ 'card-dragging': draggingIndex === index }"
				:style="getCardStyle(index)"
				@touchstart="onTouchStart($event, index)"
				@touchmove="onTouchMove($event, index)"
				@touchend="onTouchEnd($event, index)"
				@click="handleToolClick(tool)"
			>
				<view class="card-icon">
					<text class="icon-text">{{ tool.icon }}</text>
				</view>
				<text class="card-text">{{ tool.name }}</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	type ToolItem = {
		id: string
		name: string
		icon: string
	}
	
	export default {
		data() {
			return {
				tools: [] as ToolItem[],
				draggingIndex: -1,
				dragStartY: 0,
				dragCurrentY: 0,
				longPressTimer: 0,
				isDragging: false,
				originalOrder: [] as ToolItem[]
			}
		},
		onLoad() {
			this.loadTools()
		},
		methods: {
			loadTools() {
				// é»˜è®¤å·¥å…·åˆ—è¡¨
				const defaultTools: ToolItem[] = [
					{ id: 'pomodoro', name: 'ç•ªèŒ„é’Ÿ', icon: 'ğŸ…' },
					{ id: 'metronome', name: 'èŠ‚æ‹å™¨', icon: 'ğŸµ' }
				]
				
				// ä»æœ¬åœ°å­˜å‚¨è¯»å–ä¿å­˜çš„é¡ºåº
				try {
					const savedOrder = uni.getStorageSync('toolsOrder')
					if (savedOrder != null && savedOrder != "") {
						const order = JSON.parse(savedOrder.toString()) as string[]
						// æ ¹æ®ä¿å­˜çš„é¡ºåºé‡æ–°æ’åˆ—å·¥å…·
						const orderedTools: ToolItem[] = []
						for (const id of order) {
							const tool = defaultTools.find(t => t.id === id)
							if (tool != null) {
								orderedTools.push(tool)
							}
						}
						// æ·»åŠ æœªåœ¨é¡ºåºä¸­çš„å·¥å…·ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
						for (const tool of defaultTools) {
							const found = orderedTools.find(t => t.id === tool.id)
							if (found == null) {
								orderedTools.push(tool)
							}
						}
						this.tools = orderedTools
					} else {
						this.tools = defaultTools
					}
				} catch (e) {
					// å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é¡ºåº
					this.tools = defaultTools
				}
				// æ·±æ‹·è´å·¥å…·åˆ—è¡¨
				const toolsCopy: ToolItem[] = []
				for (const tool of this.tools) {
					toolsCopy.push({
						id: tool.id,
						name: tool.name,
						icon: tool.icon
					})
				}
				this.originalOrder = toolsCopy
			},
			saveToolsOrder() {
				// ä¿å­˜å·¥å…·é¡ºåºåˆ°æœ¬åœ°å­˜å‚¨
				try {
					const order = this.tools.map(tool => tool.id)
					uni.setStorageSync('toolsOrder', JSON.stringify(order))
				} catch (e) {
					console.error('ä¿å­˜å·¥å…·é¡ºåºå¤±è´¥:', e)
				}
			},
			onTouchStart(e: any, index: number) {
				if (this.isDragging) {
					return
				}
				
				// ä½¿ç”¨Mapæ–¹å¼è®¿é—®äº‹ä»¶å¯¹è±¡å±æ€§
				const eventObj = e as Map<string, any>
				if (eventObj == null) {
					return
				}
				
				const touches = eventObj.get("touches") as any[] | null
				if (touches == null || touches.length === 0) {
					return
				}
				
				const touch = touches[0] as Map<string, any> | null
				if (touch == null) {
					return
				}
				
				const clientY = touch.get("clientY") as number | null
				if (clientY == null) {
					return
				}
				
				this.dragStartY = clientY
				this.dragCurrentY = clientY
				
				// å¯åŠ¨é•¿æŒ‰è®¡æ—¶å™¨ï¼ˆ500msé•¿æŒ‰è§¦å‘æ‹–åŠ¨ï¼‰
				this.longPressTimer = setTimeout(() => {
					this.startDragging(index)
				}, 500) as number
			},
			onTouchMove(e: any, index: number) {
				// ä½¿ç”¨Mapæ–¹å¼è®¿é—®äº‹ä»¶å¯¹è±¡å±æ€§
				const eventObj = e as Map<string, any>
				if (eventObj == null) {
					return
				}
				
				const touches = eventObj.get("touches") as any[] | null
				if (touches == null || touches.length === 0) {
					return
				}
				
				const touch = touches[0] as Map<string, any> | null
				if (touch == null) {
					return
				}
				
				const clientY = touch.get("clientY") as number | null
				if (clientY == null) {
					return
				}
				
				if (this.isDragging == false) {
					// å¦‚æœç§»åŠ¨è·ç¦»è¾ƒå¤§ï¼Œå–æ¶ˆé•¿æŒ‰è®¡æ—¶å™¨
					const moveDistance = Math.abs(clientY - this.dragStartY)
					if (moveDistance > 10) {
						clearTimeout(this.longPressTimer)
						this.longPressTimer = 0
					}
					return
				}
				
				this.dragCurrentY = clientY
				
				// è®¡ç®—åº”è¯¥æ’å…¥çš„ä½ç½®
				// å¡ç‰‡é«˜åº¦150px + åº•éƒ¨é—´è·20px = 170px
				const cardHeight = 170
				const relativeY = clientY - this.dragStartY
				const rowOffset = Math.round(relativeY / cardHeight)
				const targetIndex = index + rowOffset
				
				// é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…
				if (targetIndex >= 0 && targetIndex < this.tools.length && targetIndex !== this.draggingIndex) {
					this.moveCard(this.draggingIndex, targetIndex)
				}
			},
			onTouchEnd(e: any, index: number) {
				// æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
				if (this.longPressTimer != 0) {
					clearTimeout(this.longPressTimer)
					this.longPressTimer = 0
				}
				
				if (this.isDragging) {
					this.stopDragging()
					// ä¿å­˜æ–°çš„é¡ºåº
					this.saveToolsOrder()
				}
			},
			startDragging(index: number) {
				this.isDragging = true
				this.draggingIndex = index
				// æŒ¯åŠ¨åé¦ˆï¼ˆæŸäº›å¹³å°å¯èƒ½ä¸æ”¯æŒï¼‰
				// #ifdef APP-PLUS
				try {
					uni.vibrateShort({
						type: 'medium'
					})
				} catch (e) {
					// å¿½ç•¥æŒ¯åŠ¨å¤±è´¥
				}
				// #endif
			},
			stopDragging() {
				this.isDragging = false
				this.draggingIndex = -1
				this.dragStartY = 0
				this.dragCurrentY = 0
			},
			moveCard(fromIndex: number, toIndex: number) {
				if (fromIndex === toIndex || fromIndex < 0 || toIndex < 0 || fromIndex >= this.tools.length || toIndex >= this.tools.length) {
					return
				}
				
				// åˆ›å»ºæ–°æ•°ç»„é¿å…ç›´æ¥ä¿®æ”¹
				const newTools: ToolItem[] = []
				for (let i = 0; i < this.tools.length; i++) {
					newTools.push(this.tools[i])
				}
				
				// ç§»åŠ¨å…ƒç´ 
				const [movedItem] = newTools.splice(fromIndex, 1)
				newTools.splice(toIndex, 0, movedItem)
				
				this.tools = newTools
				this.draggingIndex = toIndex
			},
			getCardStyle(index: number): string {
				if (this.isDragging && this.draggingIndex === index) {
					const offset = this.dragCurrentY - this.dragStartY
					return `transform: translateY(${offset}px); z-index: 999; opacity: 0.9;`
				}
				return ''
			},
			handleToolClick(tool: ToolItem) {
				if (this.isDragging) {
					return
				}
				
				// æ ¹æ®å·¥å…·IDè·³è½¬åˆ°å¯¹åº”é¡µé¢
				switch (tool.id) {
					case 'pomodoro':
						uni.navigateTo({
							url: '/pages/mine/tools/pomodoro'
						})
						break
					case 'metronome':
						uni.navigateTo({
							url: '/pages/mine/tools/metronome'
						})
						break
					default:
						break
				}
			},
			goBack() {
				uni.navigateBack()
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #FFB74D;
		padding: 20px;
	}
	
	.header {
		margin-top: 20px;
		margin-bottom: 30px;
		flex-direction: row;
		align-items: center;
		position: relative;
	}
	
	.back-button {
		width: 50px;
		height: 50px;
		background: rgba(255, 255, 255, 0.9);
		border-radius: 25px;
		border: 3px solid #FFFFFF;
		align-items: center;
		justify-content: center;
		box-shadow: 0px 4px 0px rgba(0,0,0,0.15), 0px 2px 0px rgba(0,0,0,0.1);
		position: absolute;
		left: 0;
		z-index: 10;
	}
	
	.back-button:active {
		transform: translateY(2px);
		box-shadow: 0px 2px 0px rgba(0,0,0,0.1), 0px 1px 0px rgba(0,0,0,0.05);
	}
	
	.back-icon {
		font-size: 24px;
		color: #FF9800;
		font-weight: bold;
	}
	
	.title {
		flex: 1;
		font-size: 32px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #FF9800;
		padding: 8px 16px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}
	
	.content {
		flex: 1;
		padding: 20px;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-around;
		align-items: flex-start;
	}
	
	.tool-card {
		width: 45%;
		height: 180px;
		background-color: #FFFFFF;
		border-radius: 20px;
		border: 4px solid #FFFFFF;
		border-bottom-width: 8px;
		border-bottom-color: #E0E0E0;
		margin-bottom: 20px;
		align-items: center;
		justify-content: center;
		position: relative;
	}
	
	.tool-card:active {
		background-color: #F5F5F5;
		border-bottom-width: 4px;
	}
	
	.card-dragging {
		background-color: #FFF9C4;
		border-width: 5px;
		border-color: #FF9800;
	}
	
	.card-icon {
		width: 90px;
		height: 90px;
		border-radius: 45px;
		background-color: #FFD4B8;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #FFB88C;
		align-items: center;
		justify-content: center;
		margin-bottom: 12px;
	}
	
	.icon-text {
		font-size: 50px;
	}
	
	.card-text {
		font-size: 18px;
		color: #FF9800;
		font-weight: bold;
		text-shadow: 1px 1px 0px #FFFFFF;
	}
</style>

