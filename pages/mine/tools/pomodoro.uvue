<template>
	<view class="container">
		<view class="header">
			<view class="back-button" @click="goBack">
				<text class="back-icon">‚Üê</text>
			</view>
			<text class="title">üçÖ Áï™ËåÑÈíü</text>
		</view>
		
		<view class="content">
			<view class="timer-display">
				<text class="timer-text">{{ formatTime(remainingTime) }}</text>
			</view>
			
			<view class="mode-selector">
				<view 
					class="mode-button" 
					v-for="mode in modes" 
					:key="mode.name"
					:class="{ 'mode-active': currentMode === mode.name }"
					@click="selectMode(mode.name)"
				>
					<text class="mode-text">{{ mode.name }}</text>
					<text class="mode-duration">{{ mode.duration }}ÂàÜÈíü</text>
				</view>
			</view>
			
			<view class="control-buttons">
				<view class="control-button" @click="toggleTimer">
					<text class="control-icon">{{ isRunning ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}</text>
					<text class="control-text">{{ isRunning ? 'ÊöÇÂÅú' : 'ÂºÄÂßã' }}</text>
				</view>
				<view class="control-button" @click="resetTimer">
					<text class="control-icon">üîÑ</text>
					<text class="control-text">ÈáçÁΩÆ</text>
				</view>
			</view>
			
			<view class="progress-bar">
				<view class="progress-fill" :style="{ width: getProgressPercent() + '%' }"></view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	type PomodoroMode = {
		name: string
		duration: number
	}
	
	export default {
		data() {
			return {
				modes: [
					{ name: 'Â∑•‰Ωú', duration: 25 },
					{ name: 'Áü≠‰ºëÊÅØ', duration: 5 },
					{ name: 'Èïø‰ºëÊÅØ', duration: 15 }
				] as PomodoroMode[],
				currentMode: 'Â∑•‰Ωú',
				remainingTime: 25 * 60 * 1000, // 25ÂàÜÈíüÔºåÂçï‰ΩçÔºöÊØ´Áßí
				totalTime: 25 * 60 * 1000,
				isRunning: false,
				timer: 0,
				startTime: 0,
				pausedTime: 0
			}
		},
		onLoad() {
			// ‰ªéÊú¨Âú∞Â≠òÂÇ®ËØªÂèñ‰øùÂ≠òÁöÑÁä∂ÊÄÅ
			this.loadState()
		},
		onHide() {
			this.pauseTimer()
			this.saveState()
		},
		onUnload() {
			this.stopTimer()
		},
		methods: {
			loadState() {
				try {
					const savedMode = uni.getStorageSync('pomodoroMode')
					if (savedMode != null && savedMode != "") {
						this.currentMode = savedMode.toString()
					}
					
					const savedTime = uni.getStorageSync('pomodoroTime')
					if (savedTime != null && savedTime != "") {
						const time = parseInt(savedTime.toString())
						if (!isNaN(time) && time > 0) {
							this.remainingTime = time
						}
					}
					
					// Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆÊÄªÊó∂Èó¥
					const mode = this.modes.find(m => m.name === this.currentMode)
					if (mode != null) {
						this.totalTime = mode.duration * 60 * 1000
						if (this.remainingTime > this.totalTime) {
							this.remainingTime = this.totalTime
						}
					}
				} catch (e) {
					// ÂøΩÁï•ÈîôËØØ
				}
			},
			saveState() {
				try {
					uni.setStorageSync('pomodoroMode', this.currentMode)
					uni.setStorageSync('pomodoroTime', this.remainingTime)
				} catch (e) {
					// ÂøΩÁï•ÈîôËØØ
				}
			},
			selectMode(modeName: string) {
				if (this.isRunning) {
					uni.showToast({
						title: 'ËØ∑ÂÖàÊöÇÂÅúËÆ°Êó∂Âô®',
						icon: 'none',
						duration: 2000
					})
					return
				}
				
				this.currentMode = modeName
				const mode = this.modes.find(m => m.name === modeName)
				if (mode != null) {
					this.totalTime = mode.duration * 60 * 1000
					this.remainingTime = this.totalTime
					this.saveState()
				}
			},
			toggleTimer() {
				if (this.isRunning) {
					this.pauseTimer()
				} else {
					this.startTimer()
				}
			},
			startTimer() {
				if (this.remainingTime <= 0) {
					this.resetTimer()
				}
				
				this.isRunning = true
				this.startTime = Date.now() - (this.totalTime - this.remainingTime)
				
				this.timer = setInterval(() => {
					const elapsed = Date.now() - this.startTime
					this.remainingTime = this.totalTime - elapsed
					
					if (this.remainingTime <= 0) {
						this.remainingTime = 0
						this.completeTimer()
					}
				}, 100) as number
			},
			pauseTimer() {
				this.isRunning = false
				this.stopTimer()
				this.saveState()
			},
			stopTimer() {
				if (this.timer != 0) {
					clearInterval(this.timer)
					this.timer = 0
				}
			},
			resetTimer() {
				this.stopTimer()
				this.isRunning = false
				const mode = this.modes.find(m => m.name === this.currentMode)
				if (mode != null) {
					this.totalTime = mode.duration * 60 * 1000
					this.remainingTime = this.totalTime
				}
				this.saveState()
			},
			completeTimer() {
				this.stopTimer()
				this.isRunning = false
				
				// ÊåØÂä®ÂíåÊèêÁ§∫ÔºàÊüê‰∫õÂπ≥Âè∞ÂèØËÉΩ‰∏çÊîØÊåÅÔºâ
				// #ifdef APP-PLUS
				try {
					uni.vibrateShort({
						type: 'heavy'
					})
				} catch (e) {
					// ÂøΩÁï•ÊåØÂä®Â§±Ë¥•
				}
				// #endif
				
				uni.showToast({
					title: `${this.currentMode}Êó∂Èó¥Âà∞ÔºÅ`,
					icon: 'success',
					duration: 3000
				})
				
				// Ëá™Âä®ÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™Ê®°Âºè
				if (this.currentMode === 'Â∑•‰Ωú') {
					// Â∑•‰ΩúÂÆåÊàêÂêéÂàáÊç¢Âà∞Áü≠‰ºëÊÅØ
					setTimeout(() => {
						this.selectMode('Áü≠‰ºëÊÅØ')
					}, 1000)
				} else {
					// ‰ºëÊÅØÂÆåÊàêÂêéÂàáÊç¢Âà∞Â∑•‰Ωú
					setTimeout(() => {
						this.selectMode('Â∑•‰Ωú')
					}, 1000)
				}
			},
			formatTime(ms: number): string {
				const totalSeconds = Math.ceil(ms / 1000)
				const minutes = Math.floor(totalSeconds / 60)
				const seconds = totalSeconds % 60
				const minStr = minutes < 10 ? '0' + minutes.toString() : minutes.toString()
				const secStr = seconds < 10 ? '0' + seconds.toString() : seconds.toString()
				return `${minStr}:${secStr}`
			},
			getProgressPercent(): number {
				if (this.totalTime === 0) {
					return 0
				}
				return ((this.totalTime - this.remainingTime) / this.totalTime) * 100
			},
			goBack() {
				this.pauseTimer()
				uni.navigateBack()
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #FFB74D;
		padding: 20px;
	}
	
	.header {
		margin-top: 20px;
		margin-bottom: 30px;
		flex-direction: row;
		align-items: center;
		position: relative;
	}
	
	.back-button {
		width: 50px;
		height: 50px;
		background-color: #FFFFFF;
		border-radius: 25px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		align-items: center;
		justify-content: center;
		position: absolute;
		left: 0;
		z-index: 10;
	}
	
	.back-button:active {
		background-color: #F5F5F5;
		border-bottom-width: 3px;
	}
	
	.back-icon {
		font-size: 24px;
		color: #FF9800;
		font-weight: bold;
	}
	
	.title {
		flex: 1;
		font-size: 32px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #FF9800;
		padding: 8px 16px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}
	
	.content {
		flex: 1;
		align-items: center;
		justify-content: center;
		padding: 20px;
	}
	
	.timer-display {
		align-items: center;
		justify-content: center;
		margin-bottom: 50px;
	}
	
	.timer-text {
		font-size: 80px;
		color: #FFFFFF;
		font-weight: bold;
		background-color: rgba(0, 0, 0, 0.3);
		padding: 12px 24px;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
	}
	
	.mode-selector {
		flex-direction: row;
		justify-content: space-around;
		width: 100%;
		margin-bottom: 40px;
	}
	
	.mode-button {
		flex: 1;
		height: 100px;
		background-color: #FFFFFF;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		align-items: center;
		justify-content: center;
		margin: 0 5px;
	}
	
	.mode-button:active {
		background-color: #F5F5F5;
		border-bottom-width: 3px;
	}
	
	.mode-active {
		background-color: #FFF9C4;
		border-color: #FF9800;
		border-width: 4px;
	}
	
	.mode-text {
		font-size: 20px;
		color: #FF9800;
		font-weight: bold;
		margin-bottom: 5px;
	}
	
	.mode-duration {
		font-size: 16px;
		color: #FF9800;
	}
	
	.control-buttons {
		flex-direction: row;
		justify-content: space-around;
		width: 100%;
		margin-bottom: 30px;
	}
	
	.control-button {
		width: 140px;
		height: 70px;
		background-color: #FFFFFF;
		border-radius: 20px;
		border: 4px solid #FFFFFF;
		border-bottom-width: 8px;
		border-bottom-color: #E0E0E0;
		align-items: center;
		justify-content: center;
	}
	
	.control-button:active {
		background-color: #F5F5F5;
		border-bottom-width: 4px;
	}
	
	.control-icon {
		font-size: 32px;
		margin-bottom: 5px;
	}
	
	.control-text {
		font-size: 18px;
		color: #FF9800;
		font-weight: bold;
	}
	
	.progress-bar {
		width: 90%;
		height: 20px;
		background-color: rgba(255, 255, 255, 0.3);
		border-radius: 10px;
		border: 2px solid #FFFFFF;
		overflow: hidden;
	}
	
	.progress-fill {
		height: 100%;
		background-color: #FF6B6B;
		border-radius: 10px;
	}
</style>

