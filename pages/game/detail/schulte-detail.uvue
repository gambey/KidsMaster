<template>
	<view class="container">
		<view class="header">
			<text class="title">ğŸ§© èˆ’å°”ç‰¹æ–¹æ ¼</text>
			<view class="print-icon" @click="showPrintDialog">
				<text class="print-icon-text">ğŸ–¨ï¸</text>
			</view>
		</view>
		
		<!-- æ‰“å°å¯¹è¯æ¡† -->
		<view class="print-dialog-mask" v-if="showPrintDialogFlag" @click="closePrintDialog">
			<view class="print-dialog" @click.stop>
				<view class="print-dialog-header">
					<text class="print-dialog-title">æ‰“å°èˆ’å°”ç‰¹æ–¹æ ¼</text>
					<view class="print-dialog-close" @click="closePrintDialog">
						<text class="print-dialog-close-text">âœ•</text>
					</view>
				</view>
				<view class="print-dialog-content">
					<text class="print-dialog-label">é€‰æ‹©éš¾åº¦ï¼š</text>
					<view class="print-size-buttons">
						<view 
							class="print-size-button" 
							v-for="size in [3, 4, 5, 6, 7, 8, 9, 10]" 
							:key="size"
							:class="{ 'print-size-button-active': printGridSize === size }"
							@click="setPrintGridSize(size)"
						>
							<text class="print-size-button-text" :class="{ 'print-size-button-text-active': printGridSize === size }">{{ size }}x{{size}}</text>
						</view>
					</view>
					<view class="print-buttons-row">
						<view class="print-preview-button" @click="previewPrintImage">
							<text class="print-preview-button-text">ğŸ‘ï¸ é¢„è§ˆ</text>
						</view>
						<view class="print-download-button" @click="downloadPrintImage">
							<text class="print-download-button-text">ğŸ“¥ ä¸‹è½½å›¾ç‰‡</text>
						</view>
					</view>
					<!-- é¢„è§ˆå›¾ç‰‡åŒºåŸŸ -->
					<view class="print-preview-container" v-if="previewImageUrl">
						<image class="print-preview-image" :src="previewImageUrl" mode="aspectFit" @error="onPreviewImageError" @load="onPreviewImageLoad"></image>
					</view>
				</view>
			</view>
		</view>
		
		<!-- Canvasç”¨äºç”Ÿæˆå›¾ç‰‡ï¼ˆéšè—ï¼‰ -->
		<!-- #ifdef H5 || MP-WEIXIN || MP-ALIPAY || MP-BAIDU || MP-TOUTIAO -->
		<canvas 
			canvas-id="printCanvas"
			class="print-canvas"
		></canvas>
		<!-- #endif -->
		<!-- #ifdef APP-ANDROID -->
		<canvas 
			id="printCanvas"
			type="2d"
			class="print-canvas"
		></canvas>
		<!-- #endif -->
		<view class="game-cover-container">
			<view class="game-cover">
				<text class="cover-emoji">ğŸ§©</text>
			</view>
		</view>
		<view class="game-info">
			<text class="game-description">å¿«é€Ÿå¯»æ‰¾åˆ°æ•°å­—ï¼Œæå‡ä¸“æ³¨èƒ½åŠ›</text>
		</view>

		<view class="settings-container">
			<text class="settings-title">é€‰æ‹©éš¾åº¦ï¼š</text>
			<view class="size-buttons">
				<view class="size-button" v-for="size in getAvailableSizes()" :key="size"
					:class="{ 'size-button-active': gridSize === size }" @click="setGridSize(size)">
					<text class="size-button-text" :class="{ 'size-button-text-active': gridSize === size }">{{ size }}x{{size}}</text>
				</view>
			</view>
		</view>

		<view class="mode-container">
			<text class="mode-title">æ¸¸æˆæ¨¡å¼ï¼š</text>
			<view class="mode-buttons">
				<view 
					class="mode-button" 
					:class="{ 'mode-button-active': gameMode === 'single' }"
					@click="setGameMode('single')"
				>
					<text class="mode-button-text" :class="{ 'mode-button-text-active': gameMode === 'single' }">ğŸ‘¤ å•äººæ¸¸æˆ</text>
				</view>
				<view 
					class="mode-button" 
					:class="{ 'mode-button-active': gameMode === 'multi' }"
					@click="setGameMode('multi')"
				>
					<text class="mode-button-text" :class="{ 'mode-button-text-active': gameMode === 'multi' }">ğŸ‘¥ åŒäººæ¸¸æˆ</text>
				</view>
			</view>
		</view>

		<view class="button-container">
			<view class="start-button" @click="startGame">
				<text class="button-text">ğŸ¯ å¼€å§‹æ¸¸æˆ</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	export default {
		data() {
			return {
				gridSize: 3,
				maxNumber: 10,
				gameMode: 'single', // 'single' å•äººæ¸¸æˆ, 'multi' åŒäººæ¸¸æˆ
				showPrintDialogFlag: false,
				printGridSize: 5, // æ‰“å°å¯¹è¯æ¡†ä¸­çš„é»˜è®¤éš¾åº¦
				previewImageUrl: '' // é¢„è§ˆå›¾ç‰‡URL
			}
		},
		onLoad(options : OnLoadOptions) {
			// å…ˆä»æœ¬åœ°å­˜å‚¨è¯»å–æ¸¸æˆæ¨¡å¼
			try {
				const savedMode = uni.getStorageSync('schulteGameMode')
				if (savedMode != null && savedMode != "") {
					const mode = savedMode.toString()
					if (mode === 'single' || mode === 'multi') {
						this.gameMode = mode
					}
				}
			} catch (e) {
				// å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
			}
			
			// ä»æœ¬åœ°å­˜å‚¨è¯»å–ç”¨æˆ·è®¾ç½®çš„é˜¶æ•°
			try {
				const savedSize = uni.getStorageSync('schulteGridSize')
				if (savedSize != null && savedSize != "") {
					const size = parseInt(savedSize.toString())
					if (!isNaN(size) && size >= 3 && size <= this.maxNumber) {
						// æ ¹æ®æ¸¸æˆæ¨¡å¼éªŒè¯å°ºå¯¸
						if (this.gameMode === 'multi' && size < 5) {
							// åŒäººæ¸¸æˆæœ€å°ä¸º5x5
							this.gridSize = 5
						} else {
							this.gridSize = size
						}
					}
				} else {
					// å¦‚æœæ²¡æœ‰ä¿å­˜çš„å°ºå¯¸ï¼Œæ ¹æ®æ¸¸æˆæ¨¡å¼è®¾ç½®é»˜è®¤å€¼
					if (this.gameMode === 'multi') {
						this.gridSize = 5
					}
				}
			} catch (e) {
				// å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
				if (this.gameMode === 'multi') {
					this.gridSize = 5
				}
			}
		},
		methods: {
			getAvailableSizes(): number[] {
				// å•äººæ¸¸æˆï¼š3x3 åˆ° 10x10
				// åŒäººæ¸¸æˆï¼š5x5 åˆ° 10x10
				if (this.gameMode === 'multi') {
					return [5, 6, 7, 8, 9, 10]
				} else {
					return [3, 4, 5, 6, 7, 8, 9, 10]
				}
			},
			setGridSize(size : number) {
				this.gridSize = size
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				try {
					uni.setStorageSync('schulteGridSize', size)
				} catch (e) {
					// å¿½ç•¥é”™è¯¯
				}
			},
			setGameMode(mode: string) {
				this.gameMode = mode
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				try {
					uni.setStorageSync('schulteGameMode', mode)
				} catch (e) {
					// å¿½ç•¥é”™è¯¯
				}
				
				// å¦‚æœåˆ‡æ¢åˆ°åŒäººæ¸¸æˆï¼Œä¸”å½“å‰gridSizeå°äº5ï¼Œè‡ªåŠ¨è°ƒæ•´ä¸º5
				if (mode === 'multi' && this.gridSize < 5) {
					this.setGridSize(5)
				}
				// å¦‚æœåˆ‡æ¢åˆ°å•äººæ¸¸æˆï¼Œä¸”å½“å‰gridSizeå°äº3ï¼Œè‡ªåŠ¨è°ƒæ•´ä¸º3
				else if (mode === 'single' && this.gridSize < 3) {
					this.setGridSize(3)
				}
			},
			startGame() {
				// æ ¹æ®æ¸¸æˆæ¨¡å¼è·³è½¬åˆ°ä¸åŒçš„é¡µé¢
				if (this.gameMode === 'multi') {
					// åŒäººæ¸¸æˆè·³è½¬åˆ° schulte-2players é¡µé¢
					uni.navigateTo({
						url: `/pages/game/schulte/schulte-2players?autoStart=true&gridSize=${this.gridSize}&gameMode=${this.gameMode}`
					})
				} else {
					// å•äººæ¸¸æˆè·³è½¬åˆ° schulte é¡µé¢
					uni.navigateTo({
						url: `/pages/game/schulte/schulte?autoStart=true&gridSize=${this.gridSize}&gameMode=${this.gameMode}`
					})
				}
			},
			showPrintDialog() {
				this.showPrintDialogFlag = true
			},
			closePrintDialog() {
				this.showPrintDialogFlag = false
				this.previewImageUrl = '' // å…³é—­å¯¹è¯æ¡†æ—¶æ¸…é™¤é¢„è§ˆ
			},
			setPrintGridSize(size: number) {
				this.printGridSize = size
			},
			generatePrintGrid(size: number): number[][] {
				// ç”ŸæˆæŒ‡å®šå¤§å°çš„éšæœºæ•°å­—ç½‘æ ¼
				const numbers: number[] = []
				const total = size * size
				for (let i = 1; i <= total; i++) {
					numbers.push(i)
				}
				// éšæœºæ‰“ä¹±
				for (let i = numbers.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1))
					const temp = numbers[i]
					numbers[i] = numbers[j]
					numbers[j] = temp
				}
				
				// åˆ›å»ºç½‘æ ¼
				const grid: number[][] = []
				for (let i = 0; i < size; i++) {
					const row: number[] = []
					for (let j = 0; j < size; j++) {
						const index = i * size + j
						row.push(numbers[index])
					}
					grid.push(row)
				}
				return grid
			},
			generatePrintImage(isPreview: boolean) {
				// A4å°ºå¯¸ï¼š210mm x 297mmï¼Œåœ¨300dpiä¸‹çº¦ä¸º2480x3508åƒç´ 
				// ä¸ºäº†é€‚é…ï¼Œä½¿ç”¨800x1132åƒç´ ï¼ˆæ¥è¿‘A4æ¯”ä¾‹ï¼‰
				const canvasWidth = 800
				const canvasHeight = 1132
				const margin = 40 // è¾¹è·
				const usableWidth = canvasWidth - margin * 2
				const usableHeight = canvasHeight - margin * 2
				
				// ç”Ÿæˆç½‘æ ¼
				const grid = this.generatePrintGrid(this.printGridSize)
				const gridSize = this.printGridSize
				
				// è®¡ç®—æ¯ä¸ªå•å…ƒæ ¼çš„å¤§å°
				const cellSize = Math.min(usableWidth / gridSize, usableHeight / gridSize)
				const gridWidth = cellSize * gridSize
				const gridHeight = cellSize * gridSize
				const startX = (canvasWidth - gridWidth) / 2
				const startY = (canvasHeight - gridHeight) / 2
				
				// #ifdef APP-ANDROID
				// Android å¹³å°æš‚ä¸æ”¯æŒ canvas 2d APIï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
				uni.hideLoading()
				uni.showToast({
					title: 'Android å¹³å°æš‚ä¸æ”¯æŒæ‰“å°åŠŸèƒ½',
					icon: 'none',
					duration: 2000
				})
				// #endif
				
				// #ifdef H5
				// Webå¹³å°ï¼šä½¿ç”¨canvasçš„toDataURLæ–¹æ³•
				const ctx = uni.createCanvasContext('printCanvas', this)
				
				// è®¾ç½®èƒŒæ™¯ä¸ºç™½è‰²
				ctx.setFillStyle('#FFFFFF' as any)
				ctx.fillRect(0, 0, canvasWidth, canvasHeight)
				
				// ç»˜åˆ¶æ ‡é¢˜
				ctx.setFillStyle('#000000' as any)
				ctx.setFontSize(24)
				ctx.setTextAlign('center')
				ctx.fillText(`èˆ’å°”ç‰¹æ–¹æ ¼ ${gridSize}x${gridSize}`, canvasWidth / 2, margin + 20)
				
				// ç»˜åˆ¶ç½‘æ ¼è¾¹æ¡†
				ctx.setStrokeStyle('#000000' as any)
				ctx.setLineWidth(2)
				
				// ç»˜åˆ¶å¤–è¾¹æ¡†
				ctx.strokeRect(startX, startY, gridWidth, gridHeight)
				
				// ç»˜åˆ¶å†…éƒ¨ç½‘æ ¼çº¿
				for (let i = 1; i < gridSize; i++) {
					const x = startX + i * cellSize
					const y = startY + i * cellSize
					// å‚ç›´çº¿
					ctx.beginPath()
					ctx.moveTo(x, startY)
					ctx.lineTo(x, startY + gridHeight)
					ctx.stroke()
					// æ°´å¹³çº¿
					ctx.beginPath()
					ctx.moveTo(startX, y)
					ctx.lineTo(startX + gridWidth, y)
					ctx.stroke()
				}
				
				// ç»˜åˆ¶æ•°å­—
				ctx.setFillStyle('#000000' as any)
				ctx.setFontSize(Math.floor(cellSize * 0.4))
				ctx.setTextAlign('center')
				ctx.setTextBaseline('middle')
				
				for (let i = 0; i < gridSize; i++) {
					for (let j = 0; j < gridSize; j++) {
						const x = startX + j * cellSize + cellSize / 2
						const y = startY + i * cellSize + cellSize / 2
						ctx.fillText(grid[i][j].toString(), x, y)
					}
				}
				
				// ç»˜åˆ¶åº•éƒ¨è¯´æ˜
				ctx.setFontSize(16)
				ctx.fillText('è¯·æŒ‰ç…§1åˆ°' + (gridSize * gridSize) + 'çš„é¡ºåºä¾æ¬¡ç‚¹å‡»', canvasWidth / 2, canvasHeight - margin)
				
				// ç»˜åˆ¶å®Œæˆ
				ctx.draw(false, () => {
					// å°†canvasè½¬ä¸ºå›¾ç‰‡
					setTimeout(() => {
						// #ifdef H5
						// Webå¹³å°ç›´æ¥ä½¿ç”¨canvasçš„toDataURLæ–¹æ³•
						try {
							// ä½¿ç”¨canvas-idæŸ¥æ‰¾canvaså…ƒç´ 
							const canvas = document.querySelector('canvas[canvas-id="printCanvas"]') as HTMLCanvasElement
							if (canvas) {
								const dataUrl = canvas.toDataURL('image/png')
								if (isPreview) {
									this.previewImageUrl = dataUrl
									setTimeout(() => {
										uni.hideLoading()
										uni.showToast({
											title: 'é¢„è§ˆå·²ç”Ÿæˆ',
											icon: 'success',
											duration: 1500
										})
									}, 100)
								} else {
									// ä¸‹è½½æ¨¡å¼
									const link = document.createElement('a')
									link.href = dataUrl
									link.download = `schulte-grid-${this.printGridSize}x${this.printGridSize}.png`
									link.click()
									uni.hideLoading()
									uni.showToast({
										title: 'å›¾ç‰‡å·²ä¸‹è½½',
										icon: 'success',
										duration: 2000
									})
									this.closePrintDialog()
								}
							} else {
								uni.hideLoading()
								uni.showToast({
									title: 'æ— æ³•è·å–ç”»å¸ƒ',
									icon: 'none',
									duration: 2000
								})
							}
						} catch (e) {
							console.error('Webå¹³å°è·å–canvaså¤±è´¥:', e)
							uni.hideLoading()
							uni.showToast({
								title: 'ç”Ÿæˆé¢„è§ˆå¤±è´¥',
								icon: 'none',
								duration: 2000
							})
						}
						// #endif
						// #ifndef H5
						// éWebå¹³å°ä½¿ç”¨uni.canvasToTempFilePath
						uni.canvasToTempFilePath({
							canvasId: 'printCanvas',
							width: canvasWidth,
							height: canvasHeight,
							destWidth: canvasWidth,
							destHeight: canvasHeight,
							success: (res) => {
								console.log('Canvasç”ŸæˆæˆåŠŸ:', res)
								if (isPreview) {
									// é¢„è§ˆæ¨¡å¼ï¼šåªæ˜¾ç¤ºå›¾ç‰‡
									let imageUrl: string | null = null
									if (res.tempFilePath != null && res.tempFilePath != "") {
										imageUrl = res.tempFilePath.toString()
									} else if (res.filePath != null && res.filePath != "") {
										imageUrl = res.filePath.toString()
									}
									console.log('è®¾ç½®é¢„è§ˆå›¾ç‰‡URL:', imageUrl)
									if (imageUrl != null && imageUrl != "") {
										this.previewImageUrl = imageUrl
										// å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿è§†å›¾æ›´æ–°
										setTimeout(() => {
											uni.hideLoading()
											uni.showToast({
												title: 'é¢„è§ˆå·²ç”Ÿæˆ',
												icon: 'success',
												duration: 1500
											})
										}, 100)
									} else {
										uni.hideLoading()
										uni.showToast({
											title: 'æ— æ³•è·å–é¢„è§ˆå›¾ç‰‡è·¯å¾„',
											icon: 'none',
											duration: 2000
										})
									}
								} else {
									// ä¸‹è½½æ¨¡å¼ï¼šä¿å­˜åˆ°ç›¸å†Œ
									uni.saveImageToPhotosAlbum({
										filePath: res.tempFilePath,
										success: () => {
											uni.hideLoading()
											uni.showToast({
												title: 'å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ',
												icon: 'success',
												duration: 2000
											})
											this.closePrintDialog()
										},
										fail: (err) => {
											console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', err)
											uni.hideLoading()
											uni.showToast({
												title: 'è¯·æˆæƒç›¸å†Œæƒé™',
												icon: 'none',
												duration: 2000
											})
										}
									})
								}
							},
							fail: (err) => {
								console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', err)
								uni.hideLoading()
								uni.showToast({
									title: 'ç”Ÿæˆå›¾ç‰‡å¤±è´¥',
									icon: 'none',
									duration: 2000
								})
							}
						}, this)
						// #endif
					}, 500)
				})
				// #endif
				// #ifdef MP-WEIXIN || MP-ALIPAY || MP-BAIDU || MP-TOUTIAO
				// å°ç¨‹åºå¹³å°ï¼šä½¿ç”¨uni.createCanvasContextå’Œuni.canvasToTempFilePath
				const ctx = uni.createCanvasContext('printCanvas', this)
				
				// è®¾ç½®èƒŒæ™¯ä¸ºç™½è‰²
				ctx.setFillStyle('#FFFFFF' as any)
				ctx.fillRect(0, 0, canvasWidth, canvasHeight)
				
				// ç»˜åˆ¶æ ‡é¢˜
				ctx.setFillStyle('#000000' as any)
				ctx.setFontSize(24)
				ctx.setTextAlign('center')
				ctx.fillText(`èˆ’å°”ç‰¹æ–¹æ ¼ ${gridSize}x${gridSize}`, canvasWidth / 2, margin + 20)
				
				// ç»˜åˆ¶ç½‘æ ¼è¾¹æ¡†
				ctx.setStrokeStyle('#000000' as any)
				ctx.setLineWidth(2)
				
				// ç»˜åˆ¶å¤–è¾¹æ¡†
				ctx.strokeRect(startX, startY, gridWidth, gridHeight)
				
				// ç»˜åˆ¶å†…éƒ¨ç½‘æ ¼çº¿
				for (let i = 1; i < gridSize; i++) {
					const x = startX + i * cellSize
					const y = startY + i * cellSize
					// å‚ç›´çº¿
					ctx.beginPath()
					ctx.moveTo(x, startY)
					ctx.lineTo(x, startY + gridHeight)
					ctx.stroke()
					// æ°´å¹³çº¿
					ctx.beginPath()
					ctx.moveTo(startX, y)
					ctx.lineTo(startX + gridWidth, y)
					ctx.stroke()
				}
				
				// ç»˜åˆ¶æ•°å­—
				ctx.setFillStyle('#000000' as any)
				ctx.setFontSize(Math.floor(cellSize * 0.4))
				ctx.setTextAlign('center')
				ctx.setTextBaseline('middle')
				
				for (let i = 0; i < gridSize; i++) {
					for (let j = 0; j < gridSize; j++) {
						const x = startX + j * cellSize + cellSize / 2
						const y = startY + i * cellSize + cellSize / 2
						ctx.fillText(grid[i][j].toString(), x, y)
					}
				}
				
				// ç»˜åˆ¶åº•éƒ¨è¯´æ˜
				ctx.setFontSize(16)
				ctx.fillText('è¯·æŒ‰ç…§1åˆ°' + (gridSize * gridSize) + 'çš„é¡ºåºä¾æ¬¡ç‚¹å‡»', canvasWidth / 2, canvasHeight - margin)
				
				// ç»˜åˆ¶å®Œæˆ
				ctx.draw(false, () => {
					// å°†canvasè½¬ä¸ºå›¾ç‰‡
					setTimeout(() => {
						// å°ç¨‹åºå¹³å°ä½¿ç”¨uni.canvasToTempFilePath
						uni.canvasToTempFilePath({
							canvasId: 'printCanvas',
							width: canvasWidth,
							height: canvasHeight,
							destWidth: canvasWidth,
							destHeight: canvasHeight,
							success: (res) => {
								console.log('Canvasç”ŸæˆæˆåŠŸ:', res)
								if (isPreview) {
									// é¢„è§ˆæ¨¡å¼ï¼šåªæ˜¾ç¤ºå›¾ç‰‡
									let imageUrl: string | null = null
									if (res.tempFilePath != null && res.tempFilePath != "") {
										imageUrl = res.tempFilePath.toString()
									} else if (res.filePath != null && res.filePath != "") {
										imageUrl = res.filePath.toString()
									}
									console.log('è®¾ç½®é¢„è§ˆå›¾ç‰‡URL:', imageUrl)
									if (imageUrl != null && imageUrl != "") {
										this.previewImageUrl = imageUrl
										// å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿è§†å›¾æ›´æ–°
										setTimeout(() => {
											uni.hideLoading()
											uni.showToast({
												title: 'é¢„è§ˆå·²ç”Ÿæˆ',
												icon: 'success',
												duration: 1500
											})
										}, 100)
									} else {
										uni.hideLoading()
										uni.showToast({
											title: 'æ— æ³•è·å–é¢„è§ˆå›¾ç‰‡è·¯å¾„',
											icon: 'none',
											duration: 2000
										})
									}
								} else {
									// ä¸‹è½½æ¨¡å¼ï¼šä¿å­˜åˆ°ç›¸å†Œ
									uni.saveImageToPhotosAlbum({
										filePath: res.tempFilePath,
										success: () => {
											uni.hideLoading()
											uni.showToast({
												title: 'å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ',
												icon: 'success',
												duration: 2000
											})
											this.closePrintDialog()
										},
										fail: (err) => {
											console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', err)
											uni.hideLoading()
											uni.showToast({
												title: 'è¯·æˆæƒç›¸å†Œæƒé™',
												icon: 'none',
												duration: 2000
											})
										}
									})
								}
							},
							fail: (err) => {
								console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', err)
								uni.hideLoading()
								uni.showToast({
									title: 'ç”Ÿæˆå›¾ç‰‡å¤±è´¥',
									icon: 'none',
									duration: 2000
								})
							}
						}, this)
					}, 500)
				})
				// #endif
			},
			previewPrintImage() {
				// æ¸…é™¤ä¹‹å‰çš„é¢„è§ˆ
				this.previewImageUrl = ''
				// æ˜¾ç¤ºåŠ è½½æç¤º
				uni.showLoading({
					title: 'ç”Ÿæˆé¢„è§ˆä¸­...',
					mask: true
				})
				// ç”Ÿæˆé¢„è§ˆå›¾ç‰‡
				this.generatePrintImage(true)
			},
			downloadPrintImage() {
				// æ˜¾ç¤ºåŠ è½½æç¤º
				uni.showLoading({
					title: 'ç”Ÿæˆå›¾ç‰‡ä¸­...',
					mask: true
				})
				// ç”Ÿæˆå¹¶ä¸‹è½½å›¾ç‰‡
				this.generatePrintImage(false)
			},
			onPreviewImageError(e: any) {
				console.error('é¢„è§ˆå›¾ç‰‡åŠ è½½å¤±è´¥:', e)
				uni.showToast({
					title: 'é¢„è§ˆå›¾ç‰‡åŠ è½½å¤±è´¥',
					icon: 'none',
					duration: 2000
				})
			},
			onPreviewImageLoad() {
				console.log('é¢„è§ˆå›¾ç‰‡åŠ è½½æˆåŠŸ')
			},
			saveImgToGallery(imgaeUrl: string) {
				// åŠŸèƒ½å·²é€šè¿‡ uni.saveImageToPhotosAlbum å®ç°
				// æ­¤æ–¹æ³•ä¿ç•™ä¸ºç©ºå®ç°ï¼Œé¿å…ç¼–è¯‘é”™è¯¯
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #B8E6D4;
		padding: 10px;
	}

	.header {
		margin-top: 10px;
		margin-bottom: 10px;
		position: relative;
		align-items: center;
		justify-content: center;
	}
	
	.print-icon {
		position: absolute;
		right: 10px;
		top: 0;
		width: 40px;
		height: 40px;
		align-items: center;
		justify-content: center;
		background-color: #4ECDC4;
		border-radius: 20px;
		border: 2px solid #FFFFFF;
	}
	
	.print-icon:active {
		background-color: #45B8B0;
	}
	
	.print-icon-text {
		font-size: 20px;
	}

	.title {
		font-size: 28px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #4ECDC4;
		padding: 6px 12px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}

	.game-cover-container {
		align-items: center;
		justify-content: center;
		margin: 10px 0;
	}

	.game-cover {
		width: 120px;
		height: 120px;
		background-color: #FFD4B8;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #FFB88C;
		align-items: center;
		justify-content: center;
	}

	.cover-emoji {
		font-size: 60px;
	}

	.game-info {
		margin: 10px 10px;
		padding: 12px;
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
	}

	.game-description {
		font-size: 16px;
		color: #4ECDC4;
		text-align: center;
		line-height: 22px;
		font-weight: bold;
	}

	.button-container {
		margin-top: 15px;
		margin-bottom: 10px;
		align-items: center;
		justify-content: center;
	}

	.start-button {
		width: 240px;
		height: 50px;
		background-color: #FF6B6B;
		border-radius: 15px;
		border: 3px solid #E63946;
		border-bottom-width: 6px;
		border-bottom-color: #E63946;
		align-items: center;
		justify-content: center;
	}

	.start-button:active {
		background-color: #FF5252;
		border-bottom-width: 3px;
	}

	.button-text {
		font-size: 20px;
		font-weight: bold;
		color: #FFFFFF;
	}

	.settings-container {
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		padding: 12px;
		margin: 10px;
	}

	.settings-title {
		font-size: 16px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 10px;
		text-align: center;
	}

	.size-buttons {
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
		align-items: center;
	}

	.size-button {
		min-width: 60px;
		height: 45px;
		background-color: #FFFFFF;
		border-radius: 10px;
		border: 3px solid #E0E0E0;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		margin: 4px;
		align-items: center;
		justify-content: center;
	}

	.size-button:active {
		background-color: #F5F5F5;
		border-bottom-width: 3px;
	}

	.size-button-active {
		background-color: #4ECDC4;
		border-color: #4ECDC4;
		border-width: 4px;
	}

	.size-button-text {
		font-size: 14px;
		font-weight: bold;
		color: #4ECDC4;
	}

	.size-button-text-active {
		color: #FFFFFF;
	}
	
	.mode-container {
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		padding: 12px;
		margin: 10px;
		margin-bottom: 15px;
	}
	
	.mode-title {
		font-size: 16px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 10px;
		text-align: center;
	}
	
	.mode-buttons {
		flex-direction: row;
		justify-content: center;
		align-items: center;
	}
	
	.mode-button {
		flex: 1;
		height: 50px;
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #E0E0E0;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		align-items: center;
		justify-content: center;
		margin: 0 5px;
	}
	
	.mode-button:active {
		background-color: #F5F5F5;
		border-bottom-width: 3px;
	}
	
	.mode-button-active {
		background-color: #4ECDC4;
		border-color: #4ECDC4;
		border-width: 4px;
	}
	
	.mode-button-text {
		font-size: 16px;
		font-weight: bold;
		color: #4ECDC4;
	}
	
	.mode-button-text-active {
		color: #FFFFFF;
	}
	
	/* æ‰“å°å¯¹è¯æ¡†æ ·å¼ */
	.print-dialog-mask {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0, 0, 0, 0.5);
		align-items: center;
		justify-content: center;
		z-index: 1000;
	}
	
	.print-dialog {
		width: 80%;
		max-width: 400px;
		background-color: #FFFFFF;
		border-radius: 15px;
		border: 3px solid #4ECDC4;
		border-bottom-width: 6px;
		border-bottom-color: #45B8B0;
		overflow: hidden;
	}
	
	.print-dialog-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		padding: 15px 20px;
		background-color: #4ECDC4;
		border-bottom-width: 2px;
		border-bottom-color: #45B8B0;
	}
	
	.print-dialog-title {
		font-size: 18px;
		font-weight: bold;
		color: #FFFFFF;
	}
	
	.print-dialog-close {
		width: 30px;
		height: 30px;
		align-items: center;
		justify-content: center;
		background-color: rgba(255, 255, 255, 0.2);
		border-radius: 15px;
	}
	
	.print-dialog-close:active {
		background-color: rgba(255, 255, 255, 0.3);
	}
	
	.print-dialog-close-text {
		font-size: 20px;
		color: #FFFFFF;
		font-weight: bold;
	}
	
	.print-dialog-content {
		padding: 20px;
	}
	
	.print-dialog-label {
		font-size: 16px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 15px;
		text-align: center;
	}
	
	.print-size-buttons {
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
		align-items: center;
		margin-bottom: 20px;
	}
	
	.print-size-button {
		min-width: 50px;
		height: 40px;
		background-color: #FFFFFF;
		border-radius: 8px;
		border: 2px solid #E0E0E0;
		border-bottom-width: 4px;
		border-bottom-color: #E0E0E0;
		margin: 4px;
		align-items: center;
		justify-content: center;
	}
	
	.print-size-button:active {
		background-color: #F5F5F5;
		border-bottom-width: 2px;
	}
	
	.print-size-button-active {
		background-color: #4ECDC4;
		border-color: #4ECDC4;
		border-width: 3px;
	}
	
	.print-size-button-text {
		font-size: 12px;
		font-weight: bold;
		color: #4ECDC4;
	}
	
	.print-size-button-text-active {
		color: #FFFFFF;
	}
	
	.print-buttons-row {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
	}
	
	.print-preview-button {
		margin-right: 5px;
	}
	
	.print-download-button {
		margin-left: 5px;
	}
	
	.print-preview-button {
		flex: 1;
		height: 50px;
		background-color: #4ECDC4;
		border-radius: 12px;
		border: 3px solid #45B8B0;
		border-bottom-width: 6px;
		border-bottom-color: #45B8B0;
		align-items: center;
		justify-content: center;
	}
	
	.print-preview-button:active {
		background-color: #45B8B0;
		border-bottom-width: 3px;
	}
	
	.print-preview-button-text {
		font-size: 18px;
		font-weight: bold;
		color: #FFFFFF;
	}
	
	.print-download-button {
		flex: 1;
		height: 50px;
		background-color: #FF6B6B;
		border-radius: 12px;
		border: 3px solid #E63946;
		border-bottom-width: 6px;
		border-bottom-color: #E63946;
		align-items: center;
		justify-content: center;
	}
	
	.print-download-button:active {
		background-color: #FF5252;
		border-bottom-width: 3px;
	}
	
	.print-download-button-text {
		font-size: 18px;
		font-weight: bold;
		color: #FFFFFF;
	}
	
	.print-preview-container {
		margin-top: 20px;
		width: 100%;
		max-height: 400px;
		background-color: #F5F5F5;
		border-radius: 10px;
		border: 2px solid #E0E0E0;
		align-items: center;
		justify-content: center;
		padding: 10px;
		overflow: hidden;
	}
	
	.print-preview-image {
		width: 100%;
		height: 100%;
		max-height: 380px;
	}
	
	.print-canvas {
		position: fixed;
		left: -9999px;
		top: -9999px;
		width: 800px;
		height: 1132px;
	}
</style>