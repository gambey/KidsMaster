<template>
	<view class="container">
		<view class="header">
			<text class="title-icon">üéß</text>
			<text class="title">Âê¨Êï∞ÊåëÊàò</text>
		</view>
		
		<view class="score-bar">
			<text class="score-text">ÂàÜÊï∞: {{ score }}</text>
			<text class="record-text">ÊúÄÈ´òËÆ∞ÂΩï: {{ highestScore }}</text>
		</view>
		
		<view class="countdown-overlay" v-if="countdown > 0">
			<text class="countdown-text">{{ countdown }}</text>
		</view>
		
		<view class="game-area">
			<!-- ÂºÄÂßãÊåâÈíÆ -->
			<view class="start-button-wrapper">
				<button class="start-button" v-if="!gameStarted" @click="startGame">
					ÂºÄ    Âßã
				</button>
				<view class="game-status" v-if="gameStarted && !gameFinished">
					<text class="status-text">Ê∏∏Êàè‰∏≠...</text>
				</view>
			</view>
			
			<!-- Êï∞Â≠óÊåâÈíÆÁΩëÊ†º -->
			<view class="number-grid">
				<!-- Á¨¨‰∏ÄË°åÔºö1, 2, 3 -->
				<view class="number-row">
					<view class="number-button" @click="handleNumberClick(1)">
						<text class="number-text">1</text>
					</view>
					<view class="number-button" @click="handleNumberClick(2)">
						<text class="number-text">2</text>
					</view>
					<view class="number-button" @click="handleNumberClick(3)">
						<text class="number-text">3</text>
					</view>
				</view>
				<!-- Á¨¨‰∫åË°åÔºö4, 5, 6 -->
				<view class="number-row">
					<view class="number-button" @click="handleNumberClick(4)">
						<text class="number-text">4</text>
					</view>
					<view class="number-button" @click="handleNumberClick(5)">
						<text class="number-text">5</text>
					</view>
					<view class="number-button" @click="handleNumberClick(6)">
						<text class="number-text">6</text>
					</view>
				</view>
				<!-- Á¨¨‰∏âË°åÔºö7, 8, 9 -->
				<view class="number-row">
					<view class="number-button" @click="handleNumberClick(7)">
						<text class="number-text">7</text>
					</view>
					<view class="number-button" @click="handleNumberClick(8)">
						<text class="number-text">8</text>
					</view>
					<view class="number-button" @click="handleNumberClick(9)">
						<text class="number-text">9</text>
					</view>
				</view>
				<!-- Á¨¨ÂõõË°åÔºö0 (ÂÆΩÊåâÈíÆ) -->
				<view class="number-row">
					<view class="number-button number-button-zero" @click="handleNumberClick(0)">
						<text class="number-text">0</text>
					</view>
				</view>
			</view>
		</view>
		
		<view class="result-overlay" v-if="gameFinished">
			<view class="result-box">
				<text class="result-title">Ê∏∏ÊàèÁªìÊùü</text>
				<text class="result-score">ÂæóÂàÜ: {{ score }}</text>
				<view class="result-buttons">
					<view class="result-button" @click="restartGame">
						<text class="button-text">ÂÜçÊù•‰∏ÄÊ¨°</text>
					</view>
					<view class="result-button" @click="goBack">
						<text class="button-text">ËøîÂõû</text>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { GameResources, getGameResourcePath } from '../../../utils/game-resources'
	
	export default {
		data() {
			return {
			gameStarted: false,
			gameFinished: false,
			score: 0,
			highestScore: 0,
			countdown: 0,
			numberSequence: [] as number[],		
			currentInputIndex: -1,
			audioTimer: 0,
			countdownTimer: 0,
			numberPositions: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
			numberPlayTimeInterval:[700,1000,1500],//Ê∏∏ÊàèÊí≠Êä•Êï∞Â≠óÈó¥ÈöîÊó∂Èó¥Ôºå‰ª£Ë°®Ê∏∏ÊàèÈöæÂ∫¶„ÄÇ
			gameLevel:0, //0:hard 1:normal 2:easy
			maxNumCnt:10, //ÊúÄÂ§ßÂæÖËæìÂÖ•Êï∞Â≠óÊï∞Èáè
			
			_audioContext: null as InnerAudioContext | null,
			}
		},
		onLoad(options: OnLoadOptions) {
			// Âä†ËΩΩÊúÄÈ´òËÆ∞ÂΩï
			try {
				const savedScore = uni.getStorageSync('numhearingHighestScore')
				if (savedScore != null && savedScore != "") {
					const scoreNum = parseInt(savedScore.toString())
					if (!isNaN(scoreNum)) {
						this.highestScore = scoreNum
					}
				}
			} catch (e) {
				// ÂøΩÁï•ÈîôËØØ
			}
			
			// ‰ªéURLÂèÇÊï∞ËØªÂèñÈöæÂ∫¶ËÆæÁΩÆ
			const difficultyParam = options["difficulty"]
			if (difficultyParam != null) {
				const diff = difficultyParam.toString()
				if (diff === 'easy') {
					this.gameLevel = 2 // easy: Èó¥Èöî 3000ms
				} else if (diff === 'normal') {
					this.gameLevel = 1 // normal: Èó¥Èöî 2000ms (ÈªòËÆ§)
				} else if (diff === 'hard') {
					this.gameLevel = 0 // hard: Èó¥Èöî 1000ms
				}
			} else {
				// Â¶ÇÊûúÊ≤°ÊúâURLÂèÇÊï∞Ôºå‰ªéÊú¨Âú∞Â≠òÂÇ®ËØªÂèñ
				try {
					const savedDifficulty = uni.getStorageSync('numhearingDifficulty')
					if (savedDifficulty != null && savedDifficulty != "") {
						const diff = savedDifficulty.toString()
						if (diff === 'easy') {
							this.gameLevel = 2
						} else if (diff === 'normal') {
							this.gameLevel = 1
						} else if (diff === 'hard') {
							this.gameLevel = 0
						}
					}
				} catch (e) {
					// ÂøΩÁï•ÈîôËØØÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
				}
			}
		},
		onHide() {
			this.stopGame()
		},
		onUnload() {
			this.stopGame()
		},
		methods: {
			startGame() {
				this.gameStarted = true
				this.gameFinished = false
				this.score = 0
				this.numberSequence = []
				this.currentInputIndex = -1
				
				this._audioContext = uni.createInnerAudioContext()
				
				// 3ÁßíÂÄíËÆ°Êó∂
				this.countdown = 3
				//Á¨¨‰∏ÄÊ¨°ÂÄíËÆ°Êó∂
				this._audioContext!.src = getGameResourcePath('numhearing','audio','countdown.mp3')
				this._audioContext?.play()
				
				this.countdownTimer = setInterval(() => {
					//play ready audio
					this._audioContext!.src = getGameResourcePath('numhearing','audio','countdown.mp3')
					this._audioContext?.play()
					this.countdown--
					if (this.countdown <= 0) {
						this.stopCountdown()
						this.startAudioSequence()
					}
				}, 1000) as number
			},
			stopCountdown() {
				if (this.countdownTimer != 0) {
					try {
						clearInterval(this.countdownTimer)
					} catch (e) {
						// ÂøΩÁï•ÈîôËØØ
					}
					this.countdownTimer = 0
				}
			},
			startAudioSequence() {
				// ÁîüÊàêÁ¨¨‰∏Ä‰∏™Êï∞Â≠óÂπ∂Êí≠Êä•
				this.generateAndPlayNumber()
				
				// ÊØèÈöînÁßíÊí≠Êä•‰∏Ä‰∏™Êï∞Â≠ó
				this.audioTimer = setInterval(() => {
					this.generateAndPlayNumber()
				}, this.numberPlayTimeInterval[this.gameLevel]) as number
			},
			generateAndPlayNumber() {
				if(this.numberSequence.length>this.maxNumCnt)
				{
					this.endGame()
					return
				}
				// ÈöèÊú∫ÁîüÊàê0-9ÁöÑÊï∞Â≠ó
				const randomNum = Math.floor(Math.random() * 10)
				this.numberSequence.push(randomNum)
				
				// Êí≠Êä•Êï∞Â≠óÔºà‰ΩøÁî®Á≥ªÁªüTTSÊàñÊòæÁ§∫ÊèêÁ§∫Ôºâ
				this.playNumberAudio(randomNum)
			},
			playNumberAudio(num: number) {
				// ‰ΩøÁî®uni.showToastÊòæÁ§∫Êï∞Â≠óÔºàÂÆûÈôÖÈ°πÁõÆ‰∏≠ÂèØ‰ª•‰ΩøÁî®TTSÔºâ
				/*uni.showToast({
					title: `Êï∞Â≠ó: ${num}`,
					icon:'none',
					duration: 500,//this.numberPlayTimeInterval[this.gameLevel]>>1,
					position: 'top',
					
				})*/
				
				// ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑÈü≥È¢ëÊí≠Êîæ
				// ‰æãÂ¶Ç‰ΩøÁî® uni.createInnerAudioContext() Êí≠ÊîæÈ¢ÑÂΩïÂà∂ÁöÑÈü≥È¢ë
				const numberAudios: string[] = [
					'/static/games/numhearing/audio/0.mp3',
					'/static/games/numhearing/audio/1.mp3',
					'/static/games/numhearing/audio/2.mp3',
					'/static/games/numhearing/audio/3.mp3',
					'/static/games/numhearing/audio/4.mp3',
					'/static/games/numhearing/audio/5.mp3',
					'/static/games/numhearing/audio/6.mp3',
					'/static/games/numhearing/audio/7.mp3',
					'/static/games/numhearing/audio/8.mp3',
					'/static/games/numhearing/audio/9.mp3'
				]
				if (num >= 0 && num <= 9) {
					this._audioContext!.src = numberAudios[num]
				} else {
					this._audioContext!.src = numberAudios[0]
				}
				this._audioContext!.play();
				
			},
			handleNumberClick(num: number) {
				if (!this.gameStarted || this.gameFinished) {
					return
				}
				
				// Ê£ÄÊü•ËæìÂÖ•ÊòØÂê¶Ê≠£Á°Æ
				const expectedIndex = this.numberSequence.length-1
				const expectedNum = this.numberSequence[0]
				if (num === expectedNum) {
					// ËæìÂÖ•Ê≠£Á°Æ
					this.score += 5
					this.numberSequence.shift()
				} else {
					// ËæìÂÖ•ÈîôËØØÔºåÊ∏∏ÊàèÁªìÊùü
					this.endGame()
				}
			},
			endGame() {
				this.gameFinished = true
				this.numberSequence = []
				this._audioContext = null
				this.stopGame()
				// Êõ¥Êñ∞ÊúÄÈ´òËÆ∞ÂΩï
				if (this.score > this.highestScore) {
					this.highestScore = this.score
					try {
						uni.setStorageSync('numhearingHighestScore', this.highestScore)
					} catch (e) {
						// ÂøΩÁï•ÈîôËØØ
					}
				}
				
				uni.showToast({
					title: 'Ê∏∏ÊàèÁªìÊùüÔºÅ',
					icon: 'none',
					duration: 2000
				})
			},
			stopGame() {
				this.stopCountdown()
				if (this.audioTimer != 0) {
					try {
						clearInterval(this.audioTimer)
					} catch (e) {
						// ÂøΩÁï•ÈîôËØØ
					}
					this.audioTimer = 0
				}
				
			},
			restartGame() {
				this.gameStarted = false
				this.gameFinished = false
				this.countdown = 0
				this._audioContext = uni.createInnerAudioContext()
			},
		
			goBack() {
				uni.navigateBack()
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #FFE4B2;
		padding: 15px;
	}
	
	.header {
		margin-top: 10px;
		margin-bottom: 25px;
		align-items: center;
		justify-content: center;
		flex-direction: row;
	}
	
	.title-icon {
		font-size: 40px;
		margin-right: 12px;
	}
	
	.title {
		font-size: 38px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #00C853;
		padding: 8px 16px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}
	
	.score-bar {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		padding: 12px 0;
		margin-bottom: 25px;
		border-bottom: 2px solid #FFD54F;
	}
	
	.score-text {
		font-size: 24px;
		color: #00C853;
		font-weight: bold;
	}
	
	.record-text {
		font-size: 20px;
		color: #00C853;
		font-weight: bold;
	}
	
	.countdown-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.7);
		align-items: center;
		justify-content: center;
		z-index: 1000;
	}
	
	.countdown-text {
		font-size: 120px;
		font-weight: bold;
		color: #FFFFFF;
		background-color: rgba(0, 0, 0, 0.5);
		padding: 20px 40px;
		border-radius: 20px;
		border: 4px solid #FFFFFF;
	}
	
	.game-area {
		width: 100%;
		align-items: center;
		justify-content: center;
		margin: 15px 0;
		padding: 0 5px;
	}
	
	.start-button-wrapper {
		width: 100%;
		align-items: center;
		justify-content: center;
		margin-bottom: 25px;
		
	}
	
	.number-grid {
		width: 100%;
		align-items: center;
		justify-content: center;
	}
	
	.number-row {
		height: 100px;
		flex-direction: row;
		justify-content: center;
		align-items: center;
		margin-bottom: 12px;
		width: 100%;
	}
	
	.number-button {
		width: 28%;
		max-width: 100px;
		height: 75px;
		background-color: #2196F3;
		border-radius: 18px;
		border: 4px solid #0D47A1;
		border-bottom-width: 8px;
		align-items: center;
		justify-content: center;
		margin: 0 6px;
	}
	
	.number-button:active {
		background-color: #1976D2;
		border-bottom-width: 4px;
	}
	
	.number-button-zero {
		width: 90%;
		max-width: 320px;
		height: 75px;
		background-color: #2196F3;
		border: 4px solid #0D47A1;
		border-bottom-width: 8px;
	}
	
	.number-text {
		font-size: 36px;
		font-weight: bold;
		color: #FFFFFF;
	}
	
	.start-button {
		width: 85%;
		max-width: 300px;
		height: 70px;
		color: white;
		text-align: center;
		border-radius: 20px;
		border: 4px solid #00B248;
		border-bottom-width: 8px;
		border-bottom-color: #00893A;
		align-items: center;
		justify-content: center;
		background-color: #00B248;
		font-size: 28px;
	}
	
	.start-button:active {
		background-color: #00893A;
		border-bottom-width: 4px;
	}
	
	.start-text {
		font-size: 34px;
		font-weight: bold;
		color: #FFFFFF;
	}
	
	.game-status {
		width: 85%;
		max-width: 300px;
		height: 70px;
		background-color: #FFF9C4;
		border-radius: 20px;
		border: 4px solid #00C853;
		border-bottom-width: 8px;
		border-bottom-color: #00A043;
		align-items: center;
		justify-content: center;
	}
	
	.status-text {
		font-size: 26px;
		font-weight: bold;
		color: #00C853;
	}
	
	.input-sequence {
		background-color: #FFFFFF;
		border-radius: 20px;
		border: 4px solid #00C853;
		border-bottom-width: 8px;
		border-bottom-color: #00A043;
		padding: 18px;
		margin-top: 20px;
		align-items: center;
		justify-content: center;
		flex-direction: row;
	}
	
	.sequence-label {
		font-size: 20px;
		color: #00C853;
		font-weight: bold;
		margin-right: 12px;
	}
	
	.sequence-text {
		font-size: 26px;
		color: #00B248;
		font-weight: bold;
		letter-spacing: 4px;
	}
	
	.result-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.7);
		align-items: center;
		justify-content: center;
		z-index: 1000;
	}
	
	.result-box {
		width: 300px;
		background-color: #FFFFFF;
		border-radius: 20px;
		border: 4px solid #4CAF50;
		border-bottom-width: 8px;
		border-bottom-color: #388E3C;
		padding: 30px;
		align-items: center;
	}
	
	.result-title {
		font-size: 28px;
		font-weight: bold;
		color: #4CAF50;
		margin-bottom: 20px;
	}
	
	.result-score {
		font-size: 24px;
		color: #66BB6A;
		font-weight: bold;
		margin-bottom: 30px;
	}
	
	.result-buttons {
		flex-direction: row;
		justify-content: space-around;
		width: 100%;
	}
	
	.result-button {
		width: 120px;
		height: 50px;
		background-color: #4CAF50;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #388E3C;
		align-items: center;
		justify-content: center;
	}
	
	.result-button:active {
		background-color: #388E3C;
		border-bottom-width: 3px;
	}
	
	.button-text {
		font-size: 18px;
		font-weight: bold;
		color: #FFFFFF;
	}
</style>
