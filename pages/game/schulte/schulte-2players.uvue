<template>
	<view class="container">
		<view class="header">
			<text class="title">ğŸ§© èˆ’å°”ç‰¹æ–¹æ ¼</text>
		</view>
		<view class="game-info-bar" v-if="gameStarted && !gameFinished">
			<text class="timer-text">â±ï¸ æ—¶é—´: {{ formatTime(elapsedTime) }}</text>
			<text class="current-text">å½“å‰: {{ currentNumber }}/{{ totalNumbers }}</text>
		</view>
		
		<view class="score-bar" v-if="gameStarted && !gameFinished">
			<view class="player-score">
				<text class="player-label">ç©å®¶1</text>
				<text class="score-value">{{ player1Score }}</text>
			</view>
			<view class="player-score">
				<text class="player-label">ç©å®¶2</text>
				<text class="score-value">{{ player2Score }}</text>
			</view>
		</view>
		
		<view class="game-info-bar" v-if="gameFinished">
			<text class="result-text">ğŸ‰ å®Œæˆï¼ç”¨æ—¶: {{ formatTime(elapsedTime) }}</text>
		</view>
		
		<view class="final-score-bar" v-if="gameFinished">
			<view class="final-score-item">
				<text class="final-score-label">ç©å®¶1</text>
				<text class="final-score-value">{{ player1Score }}åˆ†</text>
			</view>
			<view class="final-score-item">
				<text class="final-score-label">ç©å®¶2</text>
				<text class="final-score-value">{{ player2Score }}åˆ†</text>
			</view>
		</view>
		
		<view class="grid-container" v-if="gameStarted || gameFinished">
			<view class="grid-row" v-for="(row, rowIndex) in grid" :key="`row-${rowIndex}`">
				<view 
					class="grid-cell" 
					v-for="(cell, cellIndex) in row" 
					:key="`cell-${rowIndex}-${cellIndex}`"
					:class="{ 'cell-clicked': cell.clicked, 'cell-dragging': draggingCell === cell }"
					:style="{ width: cellSize + 'px', height: cellSize + 'px' }"
					@click="onCellClick(cell)"
					@touchstart="onCellTouchStart($event, cell)"
					@touchmove="onCellTouchMove($event, cell)"
					@touchend="onCellTouchEnd($event, cell)"
				>
					<text class="cell-number" :style="{ fontSize: fontSize + 'px' }">{{ cell.number }}</text>
				</view>
			</view>
		</view>
		
		<view class="drop-zones-container" v-if="gameStarted && !gameFinished">
			<view 
				class="drop-zone" 
				:class="{ 'drop-zone-active': draggingCell != null, 'drop-zone-correct': dropZone1Correct, 'drop-zone-wrong': dropZone1Wrong }"
				@click="onDropZoneClick(1)"
			>
				<text class="drop-zone-label">ç©å®¶1</text>
				<view class="drop-zone-content">
					<text class="drop-zone-number" v-if="dropZone1Number > 0">{{ dropZone1Number }}</text>
					<text class="drop-zone-placeholder" v-else>ç‚¹å‡»æ•°å­—å<br/>ç‚¹å‡»è¿™é‡Œ</text>
				</view>
			</view>
			<view 
				class="drop-zone" 
				:class="{ 'drop-zone-active': draggingCell != null, 'drop-zone-correct': dropZone2Correct, 'drop-zone-wrong': dropZone2Wrong }"
				@click="onDropZoneClick(2)"
			>
				<text class="drop-zone-label">ç©å®¶2</text>
				<view class="drop-zone-content">
					<text class="drop-zone-number" v-if="dropZone2Number > 0">{{ dropZone2Number }}</text>
					<text class="drop-zone-placeholder" v-else>ç‚¹å‡»æ•°å­—å<br/>ç‚¹å‡»è¿™é‡Œ</text>
				</view>
			</view>
		</view>
		
		<view class="button-container" v-if="gameFinished">
			<view class="restart-button" @click="restartGame">
				<text class="button-text">ğŸ”„ å†æ¥ä¸€æ¬¡</text>
			</view>
			<view class="back-button" @click="goBack">
				<text class="button-text">â† è¿”å›</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	type GridCell = {
		number: number
		clicked: boolean
	}
	
	export default {
		data() {
			return {
			gameStarted: false,
			gameFinished: false,
			grid: [] as GridCell[][],
			currentNumber: 1,
			startTime: 0,
			elapsedTime: 0,
			timer: 0,
			gridSize: 3,
			totalNumbers: 14,
			cellSize: 60,
			fontSize: 24,
			shouldAutoStart: true,
			player1Score: 0,
			player2Score: 0,
			draggingCell: null as GridCell | null,
			dragStartX: 0,
			dragStartY: 0,
			dropZone1Number: 0,
			dropZone2Number: 0,
			dropZone1Correct: false,
			dropZone1Wrong: false,
			dropZone2Correct: false,
			dropZone2Wrong: false
			}
		},
		onLoad(options: OnLoadOptions) {
			// ä¼˜å…ˆä»URLå‚æ•°è¯»å–éš¾åº¦è®¾ç½®
			const gridSizeParam = options["gridSize"]
			if (gridSizeParam != null) {
				const size = parseInt(gridSizeParam.toString())
				if (!isNaN(size) && size >= 3 && size <= this.totalNumbers) {
					this.gridSize = size
					this.updateGridConfig()
				}
			} else {
				// å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œä»æœ¬åœ°å­˜å‚¨è¯»å–ç”¨æˆ·è®¾ç½®çš„é˜¶æ•°
				try {
					const savedSize = uni.getStorageSync('schulteGridSize')
					if (savedSize != null && savedSize != "") {
						const size = parseInt(savedSize.toString())
						if (!isNaN(size) && size >= 3 && size <=  this.totalNumbers) {
							this.gridSize = size
							this.updateGridConfig()
						}
					}
				} catch (e) {
					// å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
				}
			}
			
			// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¼€å§‹æ¸¸æˆ
			const autoStart = options["autoStart"]
			if (autoStart != null) {
				const autoStartStr = autoStart.toString().toLowerCase().trim()
				if (autoStartStr === "true" || autoStartStr === "1" || autoStartStr === "yes") {
					// è®¾ç½®è‡ªåŠ¨å¼€å§‹æ ‡å¿—
					this.shouldAutoStart = true
					// å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœonReadyæ²¡æœ‰è§¦å‘ï¼Œä½¿ç”¨å»¶è¿Ÿå¯åŠ¨
					setTimeout(() => {
						if (this.shouldAutoStart && !this.gameStarted) {
							this.startGame()
							this.shouldAutoStart = false
						}
					}, 500)
				}
			}
		},
		onReady() {
			// é¡µé¢æ¸²æŸ“å®Œæˆåï¼Œå¦‚æœè®¾ç½®äº†è‡ªåŠ¨å¼€å§‹ï¼Œåˆ™å¼€å§‹æ¸¸æˆ
			if (this.shouldAutoStart && !this.gameStarted) {
				// Androidå¹³å°éœ€è¦å»¶è¿Ÿç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
				setTimeout(() => {
					if (this.shouldAutoStart && !this.gameStarted) {
						this.startGame()
						this.shouldAutoStart = false
					}
				}, 300)
			}
		},
		onHide() {
			// é¡µé¢éšè—æ—¶ä¹Ÿæ¸…ç†å®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
			this.stopTimer()
		},
		onUnload() {
			// é¡µé¢å¸è½½æ—¶ç¡®ä¿æ¸…ç†æ‰€æœ‰èµ„æº
			this.stopTimer()
			// æ¸…ç†æ•°æ®å¼•ç”¨
			this.grid = []
		},
		methods: {
			updateGridConfig() {
				this.totalNumbers = this.gridSize * this.gridSize
				// æ ¹æ®é˜¶æ•°åŠ¨æ€è°ƒæ•´å•å…ƒæ ¼å¤§å°å’Œå­—ä½“å¤§å°
				// ç¡®ä¿åœ¨å±å¹•ä¸Šèƒ½å®Œæ•´æ˜¾ç¤º
				if (this.gridSize <= 4) {
					this.cellSize = 60
					this.fontSize = 24
				} else if (this.gridSize <= 6) {
					this.cellSize = 50
					this.fontSize = 20
				} else if (this.gridSize <= 7) {
					this.cellSize = 45
					this.fontSize = 18
				} else if (this.gridSize <= 8) {
					this.cellSize = 38
					this.fontSize = 16
				} else {
					this.cellSize = 34
					this.fontSize = 14
				}
			},
			generateGrid() {
				// æ ¹æ®é˜¶æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„éšæœºæ•°ç»„
				const numbers: number[] = []
				for (let i = 1; i <= this.totalNumbers; i++) {
					numbers.push(i)
				}
				// éšæœºæ‰“ä¹±
				for (let i = numbers.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1))
					const temp = numbers[i]
					numbers[i] = numbers[j]
					numbers[j] = temp
				}
				
				// åˆ›å»ºç½‘æ ¼
				const newGrid: GridCell[][] = []
				for (let i = 0; i < this.gridSize; i++) {
					const row: GridCell[] = []
					for (let j = 0; j < this.gridSize; j++) {
						const index = i * this.gridSize + j
						row.push({
							number: numbers[index],
							clicked: false
						})
					}
					newGrid.push(row)
				}
				this.grid = newGrid
			},
			startGame() {
				// å…ˆé‡ç½®æ‰€æœ‰çŠ¶æ€
				this.gameFinished = false
				this.currentNumber = 1
				this.elapsedTime = 0
				this.player1Score = 0
				this.player2Score = 0
				this.dropZone1Number = 0
				this.dropZone2Number = 0
				this.dropZone1Correct = false
				this.dropZone1Wrong = false
				this.dropZone2Correct = false
				this.dropZone2Wrong = false
				this.draggingCell = null
				
				// å…ˆæ¸…ç©ºç½‘æ ¼ï¼Œç¡®ä¿è§†å›¾æ›´æ–°
				this.grid = []
				
				// ç”Ÿæˆæ–°ç½‘æ ¼
				this.generateGrid()
				
				// Androidå¹³å°éœ€è¦å»¶è¿Ÿè®¾ç½®gameStartedï¼Œç¡®ä¿gridå·²æ›´æ–°
				setTimeout(() => {
					this.gameStarted = true
					this.startTime = Date.now()
					this.startTimer()
				}, 100)
			},
			restartGame() {
				this.startGame()
			},
			onCellClick(cell: GridCell) {
				if (this.gameFinished || cell.clicked) {
					return
				}
				
				// é€‰ä¸­å•å…ƒæ ¼ç”¨äºæ‹–æ‹½
				if (this.draggingCell === cell) {
					// å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
					this.draggingCell = null
				} else {
					this.draggingCell = cell
				}
			},
			onCellTouchStart(e: any, cell: GridCell) {
				if (this.gameFinished || cell.clicked) {
					return
				}
				
				// é€‰ä¸­å•å…ƒæ ¼ç”¨äºæ‹–æ‹½
				if (this.draggingCell === cell) {
					// å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
					this.draggingCell = null
				} else {
					this.draggingCell = cell
				}
			},
			onCellTouchMove(e: any, cell: GridCell) {
				// ç§»åŠ¨æ—¶ä¿æŒé€‰ä¸­çŠ¶æ€
			},
			onCellTouchEnd(e: any, cell: GridCell) {
				// è§¦æ‘¸ç»“æŸï¼Œä¿æŒé€‰ä¸­çŠ¶æ€ç›´åˆ°æ”¾å…¥æ‹–æ”¾åŒºåŸŸ
			},
			onDropZoneClick(playerIndex: number) {
				if (this.draggingCell == null || this.gameFinished) {
					if (this.draggingCell == null) {
						uni.showToast({
							title: 'è¯·å…ˆç‚¹å‡»ä¸€ä¸ªæ•°å­—',
							icon: 'none',
							duration: 1000
						})
					}
					return
				}
				
				const cell = this.draggingCell
				if (cell.clicked) {
					this.draggingCell = null
					uni.showToast({
						title: 'è¿™ä¸ªæ•°å­—å·²ç»è¢«ä½¿ç”¨',
						icon: 'none',
						duration: 1000
					})
					return
				}
				
				// æ£€æŸ¥æ•°å­—æ˜¯å¦æ­£ç¡®
				const isCorrect = cell.number === this.currentNumber
				
				if (playerIndex === 1) {
					this.dropZone1Number = cell.number
					if (isCorrect) {
						this.player1Score++
						this.dropZone1Correct = true
						this.dropZone1Wrong = false
						cell.clicked = true
						this.currentNumber++
						
						uni.showToast({
							title: 'ç©å®¶1å¾—åˆ†ï¼',
							icon: 'success',
							duration: 1000
						})
						
						// æ£€æŸ¥æ˜¯å¦å®Œæˆ
						if (this.currentNumber > this.totalNumbers) {
							this.finishGame()
						} else {
							// å»¶è¿Ÿæ¸…é™¤æ­£ç¡®çŠ¶æ€
							setTimeout(() => {
								this.dropZone1Number = 0
								this.dropZone1Correct = false
							}, 1500)
						}
					} else {
						this.dropZone1Wrong = true
						this.dropZone1Correct = false
						uni.showToast({
							title: 'æ•°å­—é”™è¯¯',
							icon: 'none',
							duration: 1000
						})
						// å»¶è¿Ÿæ¸…é™¤é”™è¯¯çŠ¶æ€
						setTimeout(() => {
							this.dropZone1Number = 0
							this.dropZone1Wrong = false
						}, 1500)
					}
				} else if (playerIndex === 2) {
					this.dropZone2Number = cell.number
					if (isCorrect) {
						this.player2Score++
						this.dropZone2Correct = true
						this.dropZone2Wrong = false
						cell.clicked = true
						this.currentNumber++
						
						uni.showToast({
							title: 'ç©å®¶2å¾—åˆ†ï¼',
							icon: 'success',
							duration: 1000
						})
						
						// æ£€æŸ¥æ˜¯å¦å®Œæˆ
						if (this.currentNumber > this.totalNumbers) {
							this.finishGame()
						} else {
							// å»¶è¿Ÿæ¸…é™¤æ­£ç¡®çŠ¶æ€
							setTimeout(() => {
								this.dropZone2Number = 0
								this.dropZone2Correct = false
							}, 1500)
						}
					} else {
						this.dropZone2Wrong = true
						this.dropZone2Correct = false
						uni.showToast({
							title: 'æ•°å­—é”™è¯¯',
							icon: 'none',
							duration: 1000
						})
						// å»¶è¿Ÿæ¸…é™¤é”™è¯¯çŠ¶æ€
						setTimeout(() => {
							this.dropZone2Number = 0
							this.dropZone2Wrong = false
						}, 1500)
					}
				}
				
				this.draggingCell = null
			},
			finishGame() {
				this.gameFinished = true
				this.stopTimer()
				this.draggingCell = null
				
				// åˆ¤æ–­è·èƒœè€…
				let winnerText = ''
				if (this.player1Score > this.player2Score) {
					winnerText = 'ç©å®¶1è·èƒœï¼'
				} else if (this.player2Score > this.player1Score) {
					winnerText = 'ç©å®¶2è·èƒœï¼'
				} else {
					winnerText = 'å¹³å±€ï¼'
				}
				
				uni.showToast({
					title: `å¤ªæ£’äº†ï¼å®Œæˆæ¸¸æˆï¼${winnerText}`,
					icon: 'success',
					duration: 3000
				})
			},
			startTimer() {
				// å…ˆæ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
				this.stopTimer()
				// åˆ›å»ºæ–°çš„å®šæ—¶å™¨
				const timerId = setInterval(() => {
					// æ£€æŸ¥æ¸¸æˆæ˜¯å¦è¿˜åœ¨è¿›è¡Œä¸­
					if (this.gameStarted && !this.gameFinished) {
						this.elapsedTime = Date.now() - this.startTime
					}
				}, 100)
				this.timer = timerId as number
			},
			stopTimer() {
				if (this.timer != 0) {
					try {
						clearInterval(this.timer)
					} catch (e) {
						// å¿½ç•¥æ¸…ç†é”™è¯¯
					}
					this.timer = 0
				}
			},
			formatTime(ms: number): string {
				const seconds = Math.floor(ms / 1000)
				const minutes = Math.floor(seconds / 60)
				const secs = seconds % 60
				const millis = Math.floor((ms % 1000) / 100)
				if (minutes > 0) {
					return `${minutes}åˆ†${secs}ç§’`
				}
				return `${secs}.${millis}ç§’`
			},
			goBack() {
				uni.navigateBack()
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #B8E6D4;
		padding: 10px;
		width: 100%;
	}
	
	.header {
		margin-top: 10px;
		margin-bottom: 10px;
	}
	
	.title {
		font-size: 28px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #4ECDC4;
		padding: 6px 12px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}
	
	.game-info-bar {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		padding: 10px 15px;
		margin-bottom: 10px;
		width: 100%;
	}
	
	.info-text {
		font-size: 18px;
		color: #4ECDC4;
		font-weight: bold;
		text-align: center;
		flex: 1;
	}
	
	.timer-text {
		font-size: 16px;
		color: #FF6B6B;
		font-weight: bold;
	}
	
	.current-text {
		font-size: 16px;
		color: #4ECDC4;
		font-weight: bold;
	}
	
	.result-text {
		font-size: 18px;
		color: #FF6B6B;
		font-weight: bold;
		text-align: center;
		flex: 1;
	}
	
	.grid-container {
		width: 100%;
		align-items: center;
		justify-content: center;
		margin: 10px 0;
		padding: 5px;
	}
	
	.grid-row {
		flex-direction: row;
		justify-content: center;
		align-items: center;
		margin-bottom: 4px;
		width: 100%;
	}
	
	.grid-cell {
		background-color: #FFD4B8;
		border-radius: 12px;
		border: 3px solid #FF6B6B;
		border-bottom-width: 6px;
		border-bottom-color: #E63946;
		margin: 2px;
		align-items: center;
		justify-content: center;
		position: relative;
	}
	
	.grid-cell:active {
		background-color: #FFC8A2;
		border-bottom-width: 3px;
	}
	
	.cell-number {
		font-weight: bold;
		color: #FF6B6B;
		text-align: center;
		line-height: 1;
	}
	
	.cell-clicked {
		background-color: #6A6A6A;
		border-color: #4A4A4A;
		opacity: 0.8;
	}
	
	.cell-clicked .cell-number {
		color: #CCCCCC;
		text-decoration: line-through;
	}
	
	.cell-current {
		background-color: #FFD4B8;
		border-color: #FF6B6B;
		border-width: 4px;
	}
	
	.cell-current .cell-number {
		color: #FF6B6B;
		font-size: 28px;
	}
	
	.button-container {
		margin-top: 15px;
		margin-bottom: 10px;
		width: 100%;
		align-items: center;
		justify-content: center;
		flex-direction: row;
		flex-wrap: wrap;
		padding: 5px;
	}
	
	.start-button {
		width: 180px;
		min-width: 160px;
		height: 50px;
		min-height: 45px;
		background-color: #FF6B6B;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E63946;
		align-items: center;
		justify-content: center;
		margin: 5px;
	}
	
	.start-button:active {
		background-color: #FF5252;
		border-bottom-width: 3px;
	}
	
	.restart-button {
		width: 140px;
		height: 50px;
		background-color: #4ECDC4;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #3AB5AD;
		align-items: center;
		justify-content: center;
		margin: 5px;
	}
	
	.restart-button:active {
		background-color: #3AB5AD;
		border-bottom-width: 3px;
	}
	
	.back-button {
		width: 140px;
		height: 50px;
		background-color: #FFD4B8;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #FFB88C;
		align-items: center;
		justify-content: center;
		margin: 5px;
	}
	
	.back-button:active {
		background-color: #FFB88C;
		border-bottom-width: 3px;
	}
	
	.button-text {
		font-size: 18px;
		font-weight: bold;
		color: #FFFFFF;
	}
	
	.score-bar {
		flex-direction: row;
		justify-content: space-around;
		align-items: center;
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		padding: 10px 15px;
		margin-bottom: 10px;
		width: 100%;
	}
	
	.player-score {
		align-items: center;
		justify-content: center;
		flex: 1;
	}
	
	.player-label {
		font-size: 14px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 5px;
	}
	
	.score-value {
		font-size: 24px;
		color: #FF6B6B;
		font-weight: bold;
	}
	
	.drop-zones-container {
		width: 100%;
		flex-direction: row;
		justify-content: space-around;
		align-items: center;
		margin-top: 15px;
		margin-bottom: 10px;
		padding: 0 10px;
	}
	
	.drop-zone {
		flex: 1;
		height: 100px;
		background-color: #FFFFFF;
		border-radius: 15px;
		border: 3px solid #E0E0E0;
		border-bottom-width: 6px;
		border-bottom-color: #D0D0D0;
		margin: 0 5px;
		align-items: center;
		justify-content: center;
		padding: 10px;
	}
	
	.drop-zone-active {
		border-color: #4ECDC4;
		border-width: 4px;
		background-color: #E8F5E9;
	}
	
	.drop-zone-correct {
		background-color: #C8E6C9;
		border-color: #4CAF50;
	}
	
	.drop-zone-wrong {
		background-color: #FFCDD2;
		border-color: #F44336;
	}
	
	.drop-zone-label {
		font-size: 14px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 5px;
	}
	
	.drop-zone-content {
		align-items: center;
		justify-content: center;
		flex: 1;
	}
	
	.drop-zone-number {
		font-size: 32px;
		font-weight: bold;
		color: #FF6B6B;
	}
	
	.drop-zone-placeholder {
		font-size: 12px;
		color: #999999;
		text-align: center;
		line-height: 16px;
	}
	
	.cell-dragging {
		background-color: #FFF9C4;
		border-color: #FFD54F;
		border-width: 4px;
	}
	
	.final-score-bar {
		flex-direction: row;
		justify-content: space-around;
		align-items: center;
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		padding: 15px;
		margin: 10px;
		margin-bottom: 15px;
		width: 100%;
	}
	
	.final-score-item {
		align-items: center;
		justify-content: center;
		flex: 1;
	}
	
	.final-score-label {
		font-size: 16px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 8px;
	}
	
	.final-score-value {
		font-size: 28px;
		color: #FF6B6B;
		font-weight: bold;
	}
</style>
