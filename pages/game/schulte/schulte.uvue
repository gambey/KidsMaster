<template>
	<view class="container">
		<view class="header">
			<text class="title">ğŸ§© èˆ’å°”ç‰¹æ–¹æ ¼</text>
		</view>
		
		<view class="game-info-bar" v-if="!gameStarted">
			<text class="info-text">æŒ‰ç…§ 1 â†’ {{ totalNumbers }} çš„é¡ºåºç‚¹å‡»æ•°å­—</text>
		</view>
		
		<view class="settings-container" v-if="!gameStarted">
			<text class="settings-title">é€‰æ‹©éš¾åº¦ï¼š</text>
			<view class="size-buttons">
				<view 
					class="size-button" 
					v-for="size in [3, 4, 5, 6, 7, 8, 9]" 
					:key="size"
					:class="{ 'size-button-active': gridSize === size }"
					@click="setGridSize(size)"
				>
					<text class="size-button-text">{{ size }}Ã—{{ size }}</text>
				</view>
			</view>
		</view>
		
		<view class="game-info-bar" v-if="gameStarted && !gameFinished">
			<text class="timer-text">â±ï¸ æ—¶é—´: {{ formatTime(elapsedTime) }}</text>
			<text class="current-text">å½“å‰: {{ currentNumber }}/{{ totalNumbers }}</text>
		</view>
		
		<view class="game-info-bar" v-if="gameFinished">
			<text class="result-text">ğŸ‰ å®Œæˆï¼ç”¨æ—¶: {{ formatTime(elapsedTime) }}</text>
		</view>
		
		<view class="grid-container" v-if="gameStarted || gameFinished">
			<view class="grid-row" v-for="(row, rowIndex) in grid" :key="rowIndex">
				<view 
					class="grid-cell" 
					v-for="(cell, cellIndex) in row" 
					:key="cellIndex"
					:class="{ 'cell-clicked': cell.clicked }"
					:style="{ width: cellSize + 'px', height: cellSize + 'px' }"
					@click="handleCellClick(cell)"
				>
					<text class="cell-number" :style="{ fontSize: fontSize + 'px' }">{{ cell.number }}</text>
				</view>
			</view>
		</view>
		
		<view class="button-container" v-if="!gameStarted">
			<view class="start-button" @click="startGame">
				<text class="button-text">ğŸš€ å¼€å§‹æ¸¸æˆ</text>
			</view>
		</view>
		
		<view class="button-container" v-if="gameFinished">
			<view class="restart-button" @click="restartGame">
				<text class="button-text">ğŸ”„ å†æ¥ä¸€æ¬¡</text>
			</view>
			<view class="back-button" @click="goBack">
				<text class="button-text">â† è¿”å›</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	type GridCell = {
		number: number
		clicked: boolean
	}
	
	export default {
		data() {
			return {
			gameStarted: false,
			gameFinished: false,
			grid: [] as GridCell[][],
			currentNumber: 1,
			startTime: 0,
			elapsedTime: 0,
			timer: 0,
			gridSize: 3,
			totalNumbers: 9,
			cellSize: 60,
			fontSize: 24
			}
		},
		onLoad(options: OnLoadOptions) {
			// ä»æœ¬åœ°å­˜å‚¨è¯»å–ç”¨æˆ·è®¾ç½®çš„é˜¶æ•°
			try {
				const savedSize = uni.getStorageSync('schulteGridSize')
				if (savedSize != null && savedSize != "") {
					const size = savedSize as number
					if (size >= 3 && size <= 9) {
						this.gridSize = size as number
						this.updateGridConfig()
					}
				}
			} catch (e) {
				// å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
			}
			
			// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¼€å§‹æ¸¸æˆ
			const autoStart = options["autoStart"]
			if (autoStart != null) {
				const autoStartStr = autoStart.toString()
				if (autoStartStr === "true" || autoStartStr === "1") {
					// å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿é¡µé¢æ¸²æŸ“å®Œæˆ
					setTimeout(() => {
						this.startGame()
					}, 100)
				}
			}
		},
		onHide() {
			// é¡µé¢éšè—æ—¶ä¹Ÿæ¸…ç†å®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
			this.stopTimer()
		},
		onUnload() {
			// é¡µé¢å¸è½½æ—¶ç¡®ä¿æ¸…ç†æ‰€æœ‰èµ„æº
			this.stopTimer()
			// æ¸…ç†æ•°æ®å¼•ç”¨
			this.grid = []
		},
		methods: {
			setGridSize(size: number) {
				this.gridSize = size
				this.updateGridConfig()
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				try {
					uni.setStorageSync('schulteGridSize', size)
				} catch (e) {
					// å¿½ç•¥é”™è¯¯
				}
			},
			updateGridConfig() {
				this.totalNumbers = this.gridSize * this.gridSize
				// æ ¹æ®é˜¶æ•°åŠ¨æ€è°ƒæ•´å•å…ƒæ ¼å¤§å°å’Œå­—ä½“å¤§å°
				// ç¡®ä¿åœ¨å±å¹•ä¸Šèƒ½å®Œæ•´æ˜¾ç¤º
				if (this.gridSize <= 4) {
					this.cellSize = 60
					this.fontSize = 24
				} else if (this.gridSize <= 6) {
					this.cellSize = 50
					this.fontSize = 20
				} else if (this.gridSize <= 7) {
					this.cellSize = 45
					this.fontSize = 18
				} else {
					this.cellSize = 40
					this.fontSize = 16
				}
			},
			generateGrid() {
				// æ ¹æ®é˜¶æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„éšæœºæ•°ç»„
				const numbers: number[] = []
				for (let i = 1; i <= this.totalNumbers; i++) {
					numbers.push(i)
				}
				// éšæœºæ‰“ä¹±
				for (let i = numbers.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1))
					const temp = numbers[i]
					numbers[i] = numbers[j]
					numbers[j] = temp
				}
				
				// åˆ›å»ºç½‘æ ¼
				const newGrid: GridCell[][] = []
				for (let i = 0; i < this.gridSize; i++) {
					const row: GridCell[] = []
					for (let j = 0; j < this.gridSize; j++) {
						const index = i * this.gridSize + j
						row.push({
							number: numbers[index],
							clicked: false
						})
					}
					newGrid.push(row)
				}
				this.grid = newGrid
			},
			startGame() {
				this.generateGrid()
				this.gameStarted = true
				this.gameFinished = false
				this.currentNumber = 1
				this.startTime = Date.now()
				this.elapsedTime = 0
				this.startTimer()
			},
			restartGame() {
				this.startGame()
			},
			handleCellClick(cell: GridCell) {
				if (this.gameFinished || cell.clicked) {
					return
				}
				
				if (cell.number === this.currentNumber) {
					cell.clicked = true
					this.currentNumber++
					
					// æ£€æŸ¥æ˜¯å¦å®Œæˆ
					if (this.currentNumber > this.totalNumbers) {
						this.finishGame()
					}
				} else {
					// ç‚¹å‡»é”™è¯¯ï¼Œæç¤º
					uni.showToast({
						title: 'é¡ºåºä¸å¯¹å“¦ï¼Œç»§ç»­åŠ æ²¹ï¼',
						icon: 'none',
						duration: 1000
					})
				}
			},
			finishGame() {
				this.gameFinished = true
				this.stopTimer()
				uni.showToast({
					title: 'å¤ªæ£’äº†ï¼å®Œæˆæ¸¸æˆï¼',
					icon: 'success',
					duration: 2000
				})
			},
			startTimer() {
				// å…ˆæ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
				this.stopTimer()
				// åˆ›å»ºæ–°çš„å®šæ—¶å™¨
				const timerId = setInterval(() => {
					// æ£€æŸ¥æ¸¸æˆæ˜¯å¦è¿˜åœ¨è¿›è¡Œä¸­
					if (this.gameStarted && !this.gameFinished) {
						this.elapsedTime = Date.now() - this.startTime
					}
				}, 100)
				this.timer = timerId as number
			},
			stopTimer() {
				if (this.timer != 0) {
					try {
						clearInterval(this.timer)
					} catch (e) {
						// å¿½ç•¥æ¸…ç†é”™è¯¯
					}
					this.timer = 0
				}
			},
			formatTime(ms: number): string {
				const seconds = Math.floor(ms / 1000)
				const minutes = Math.floor(seconds / 60)
				const secs = seconds % 60
				const millis = Math.floor((ms % 1000) / 100)
				if (minutes > 0) {
					return `${minutes}åˆ†${secs}ç§’`
				}
				return `${secs}.${millis}ç§’`
			},
			goBack() {
				uni.navigateBack()
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background: linear-gradient(135deg, #A8E6CF 0%, #D4F1F4 100%);
		padding: 20px;
	}
	
	.header {
		margin-top: 20px;
		margin-bottom: 20px;
	}
	
	.title {
		font-size: 32px;
		font-weight: bold;
		color: #4ECDC4;
		text-align: center;
		text-shadow: 2px 2px 0px #FFFFFF, 4px 4px 0px rgba(0,0,0,0.1);
	}
	
	.game-info-bar {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		background: rgba(255, 255, 255, 0.8);
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		padding: 15px 20px;
		margin-bottom: 20px;
		box-shadow: 0px 4px 0px rgba(0,0,0,0.1);
	}
	
	.info-text {
		font-size: 18px;
		color: #4ECDC4;
		font-weight: bold;
		text-align: center;
		flex: 1;
	}
	
	.timer-text {
		font-size: 18px;
		color: #FF6B6B;
		font-weight: bold;
	}
	
	.current-text {
		font-size: 18px;
		color: #4ECDC4;
		font-weight: bold;
	}
	
	.result-text {
		font-size: 20px;
		color: #FF6B6B;
		font-weight: bold;
		text-align: center;
		flex: 1;
	}
	
	.settings-container {
		background: rgba(255, 255, 255, 0.8);
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		padding: 20px;
		margin-bottom: 20px;
		box-shadow: 0px 4px 0px rgba(0,0,0,0.1);
	}
	
	.settings-title {
		font-size: 18px;
		color: #4ECDC4;
		font-weight: bold;
		margin-bottom: 15px;
		text-align: center;
	}
	
	.size-buttons {
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
		align-items: center;
	}
	
	.size-button {
		min-width: 70px;
		height: 50px;
		background: rgba(255, 255, 255, 0.9);
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		margin: 5px;
		align-items: center;
		justify-content: center;
		box-shadow: 0px 4px 0px rgba(0,0,0,0.1), 0px 2px 0px rgba(0,0,0,0.05);
	}
	
	.size-button:active {
		transform: translateY(2px);
		box-shadow: 0px 2px 0px rgba(0,0,0,0.05), 0px 1px 0px rgba(0,0,0,0.02);
	}
	
	.size-button-active {
		background: linear-gradient(135deg, #4ECDC4 0%, #95E1D3 100%);
		border-color: #4ECDC4;
	}
	
	.size-button-text {
		font-size: 16px;
		font-weight: bold;
		color: #4ECDC4;
	}
	
	.size-button-active .size-button-text {
		color: #FFFFFF;
		text-shadow: 1px 1px 0px rgba(0,0,0,0.2);
	}
	
	.grid-container {
		width: 100%;
		align-items: center;
		justify-content: center;
		margin: 20px 0;
	}
	
	.grid-row {
		flex-direction: row;
		justify-content: center;
		margin-bottom: 4px;
	}
	
	.grid-cell {
		background: linear-gradient(135deg, #FFE5B4 0%, #FFCCCB 100%);
		border-radius: 12px;
		border: 3px solid #FF6B6B;
		margin: 2px;
		align-items: center;
		justify-content: center;
		box-shadow: 0px 4px 0px rgba(255, 107, 107, 0.3), 0px 2px 0px rgba(255, 107, 107, 0.2);
	}
	
	.grid-cell:active {
		transform: translateY(2px);
		box-shadow: 0px 2px 0px rgba(255, 107, 107, 0.2), 0px 1px 0px rgba(255, 107, 107, 0.1);
	}
	
	.cell-number {
		font-weight: bold;
		color: #FF6B6B;
		text-shadow: 2px 2px 0px #FFFFFF, 1px 1px 0px rgba(0,0,0,0.1);
	}
	
	.cell-clicked {
		background: linear-gradient(135deg, #7A7E83 0%, #5A5A5A 100%);
		border-color: #4A4A4A;
		opacity: 0.8;
	}
	
	.cell-clicked .cell-number {
		color: #CCCCCC;
		text-shadow: 2px 2px 0px rgba(0,0,0,0.5), 1px 1px 0px rgba(0,0,0,0.3);
		text-decoration: line-through;
	}
	
	.cell-current {
		background: linear-gradient(135deg, #FFE5B4 0%, #FFCCCB 100%);
		border-color: #FF6B6B;
		box-shadow: 0px 4px 0px rgba(255, 107, 107, 0.3), 0px 2px 0px rgba(255, 107, 107, 0.2);
	}
	
	.cell-current .cell-number {
		color: #FF6B6B;
		font-size: 28px;
	}
	
	.button-container {
		margin-top: 30px;
		align-items: center;
		justify-content: center;
		flex-direction: row;
		flex-wrap: wrap;
	}
	
	.start-button {
		width: 200px;
		height: 60px;
		background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
		border-radius: 20px;
		border: 4px solid #FFFFFF;
		box-shadow: 0px 8px 0px rgba(0,0,0,0.2), 0px 4px 0px rgba(0,0,0,0.15);
		align-items: center;
		justify-content: center;
		margin: 10px;
	}
	
	.start-button:active {
		transform: translateY(2px);
		box-shadow: 0px 4px 0px rgba(0,0,0,0.15), 0px 2px 0px rgba(0,0,0,0.1);
	}
	
	.restart-button {
		width: 160px;
		height: 60px;
		background: linear-gradient(135deg, #4ECDC4 0%, #95E1D3 100%);
		border-radius: 20px;
		border: 4px solid #FFFFFF;
		box-shadow: 0px 8px 0px rgba(0,0,0,0.2), 0px 4px 0px rgba(0,0,0,0.15);
		align-items: center;
		justify-content: center;
		margin: 10px;
	}
	
	.restart-button:active {
		transform: translateY(2px);
		box-shadow: 0px 4px 0px rgba(0,0,0,0.15), 0px 2px 0px rgba(0,0,0,0.1);
	}
	
	.back-button {
		width: 160px;
		height: 60px;
		background: linear-gradient(135deg, #FFE5B4 0%, #FFCCCB 100%);
		border-radius: 20px;
		border: 4px solid #FFFFFF;
		box-shadow: 0px 8px 0px rgba(0,0,0,0.2), 0px 4px 0px rgba(0,0,0,0.15);
		align-items: center;
		justify-content: center;
		margin: 10px;
	}
	
	.back-button:active {
		transform: translateY(2px);
		box-shadow: 0px 4px 0px rgba(0,0,0,0.15), 0px 2px 0px rgba(0,0,0,0.1);
	}
	
	.button-text {
		font-size: 20px;
		font-weight: bold;
		color: #FFFFFF;
		text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
	}
</style>
