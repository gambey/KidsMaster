<template>
	<view class="container">
		<view class="header">
			<text class="title">ğŸ§© èˆ’å°”ç‰¹æ–¹æ ¼</text>
		</view>
		<view class="game-info-bar" v-if="gameStarted && !gameFinished">
			<text class="timer-text">â±ï¸ æ—¶é—´: {{ formatTime(elapsedTime) }}</text>
			<text class="current-text">å½“å‰: {{ currentNumber }}/{{ totalNumbers }}</text>
		</view>
		
		<view class="game-info-bar" v-if="gameFinished">
			<text class="result-text">ğŸ‰ å®Œæˆï¼ç”¨æ—¶: {{ formatTime(elapsedTime) }}</text>
		</view>
		
		<view class="grid-container" v-if="gameStarted || gameFinished">
			<view class="grid-row" v-for="(row, rowIndex) in grid" :key="`row-${rowIndex}`">
				<view 
					class="grid-cell" 
					v-for="(cell, cellIndex) in row" 
					:key="`cell-${rowIndex}-${cellIndex}`"
					:class="{ 'cell-clicked': cell.clicked }"
					:style="{ width: cellSize + 'px', height: cellSize + 'px' }"
					@click="handleCellClick(cell)"
				>
					<text class="cell-number" :style="{ fontSize: fontSize + 'px' }">{{ cell.number }}</text>
				</view>
			</view>
		</view>
		
		<view class="button-container" v-if="gameFinished">
			<view class="restart-button" @click="restartGame">
				<text class="button-text">ğŸ”„ å†æ¥ä¸€æ¬¡</text>
			</view>
			<view class="back-button" @click="goBack">
				<text class="button-text">â† è¿”å›</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	type GridCell = {
		number: number
		clicked: boolean
	}
	
	export default {
		data() {
			return {
			gameStarted: false,
			gameFinished: false,
			grid: [] as GridCell[][],
			currentNumber: 1,
			startTime: 0,
			elapsedTime: 0,
			timer: 0,
			gridSize: 3,
			totalNumbers: 14,
			cellSize: 60,
			fontSize: 24,
			shouldAutoStart: true
			}
		},
		onLoad(options: OnLoadOptions) {
			// ä¼˜å…ˆä»URLå‚æ•°è¯»å–éš¾åº¦è®¾ç½®
			const gridSizeParam = options["gridSize"]
			if (gridSizeParam != null) {
				const size = parseInt(gridSizeParam.toString())
				if (!isNaN(size) && size >= 3 && size <= this.totalNumbers) {
					this.gridSize = size
					this.updateGridConfig()
				}
			} else {
				// å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œä»æœ¬åœ°å­˜å‚¨è¯»å–ç”¨æˆ·è®¾ç½®çš„é˜¶æ•°
				try {
					const savedSize = uni.getStorageSync('schulteGridSize')
					if (savedSize != null && savedSize != "") {
						const size = parseInt(savedSize.toString())
						if (!isNaN(size) && size >= 3 && size <=  this.totalNumbers) {
							this.gridSize = size
							this.updateGridConfig()
						}
					}
				} catch (e) {
					// å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
				}
			}
			
			// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¼€å§‹æ¸¸æˆ
			const autoStart = options["autoStart"]
			if (autoStart != null) {
				const autoStartStr = autoStart.toString().toLowerCase().trim()
				if (autoStartStr === "true" || autoStartStr === "1" || autoStartStr === "yes") {
					// è®¾ç½®è‡ªåŠ¨å¼€å§‹æ ‡å¿—
					this.shouldAutoStart = true
					// å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœonReadyæ²¡æœ‰è§¦å‘ï¼Œä½¿ç”¨å»¶è¿Ÿå¯åŠ¨
					setTimeout(() => {
						if (this.shouldAutoStart && !this.gameStarted) {
							this.startGame()
							this.shouldAutoStart = false
						}
					}, 500)
				}
			}
		},
		onReady() {
			// é¡µé¢æ¸²æŸ“å®Œæˆåï¼Œå¦‚æœè®¾ç½®äº†è‡ªåŠ¨å¼€å§‹ï¼Œåˆ™å¼€å§‹æ¸¸æˆ
			if (this.shouldAutoStart && !this.gameStarted) {
				// Androidå¹³å°éœ€è¦å»¶è¿Ÿç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
				setTimeout(() => {
					if (this.shouldAutoStart && !this.gameStarted) {
						this.startGame()
						this.shouldAutoStart = false
					}
				}, 300)
			}
		},
		onHide() {
			// é¡µé¢éšè—æ—¶ä¹Ÿæ¸…ç†å®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
			this.stopTimer()
		},
		onUnload() {
			// é¡µé¢å¸è½½æ—¶ç¡®ä¿æ¸…ç†æ‰€æœ‰èµ„æº
			this.stopTimer()
			// æ¸…ç†æ•°æ®å¼•ç”¨
			this.grid = []
		},
		methods: {
			updateGridConfig() {
				this.totalNumbers = this.gridSize * this.gridSize
				// æ ¹æ®é˜¶æ•°åŠ¨æ€è°ƒæ•´å•å…ƒæ ¼å¤§å°å’Œå­—ä½“å¤§å°
				// ç¡®ä¿åœ¨å±å¹•ä¸Šèƒ½å®Œæ•´æ˜¾ç¤º
				if (this.gridSize <= 4) {
					this.cellSize = 60
					this.fontSize = 24
				} else if (this.gridSize <= 6) {
					this.cellSize = 50
					this.fontSize = 20
				} else if (this.gridSize <= 7) {
					this.cellSize = 45
					this.fontSize = 18
				} else if (this.gridSize <= 8) {
					this.cellSize = 38
					this.fontSize = 16
				} else if (this.gridSize <= 9) {
					this.cellSize = 36
					this.fontSize = 16
				} 
				else {
					this.cellSize = 31
					this.fontSize = 14
				}
			},
			generateGrid() {
				// æ ¹æ®é˜¶æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„éšæœºæ•°ç»„
				const numbers: number[] = []
				for (let i = 1; i <= this.totalNumbers; i++) {
					numbers.push(i)
				}
				// éšæœºæ‰“ä¹±
				for (let i = numbers.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1))
					const temp = numbers[i]
					numbers[i] = numbers[j]
					numbers[j] = temp
				}
				
				// åˆ›å»ºç½‘æ ¼
				const newGrid: GridCell[][] = []
				for (let i = 0; i < this.gridSize; i++) {
					const row: GridCell[] = []
					for (let j = 0; j < this.gridSize; j++) {
						const index = i * this.gridSize + j
						row.push({
							number: numbers[index],
							clicked: false
						})
					}
					newGrid.push(row)
				}
				this.grid = newGrid
			},
			startGame() {
				// å…ˆé‡ç½®æ‰€æœ‰çŠ¶æ€
				this.gameFinished = false
				this.currentNumber = 1
				this.elapsedTime = 0
				
				// å…ˆæ¸…ç©ºç½‘æ ¼ï¼Œç¡®ä¿è§†å›¾æ›´æ–°
				this.grid = []
				
				// ç”Ÿæˆæ–°ç½‘æ ¼
				this.generateGrid()
				
				// Androidå¹³å°éœ€è¦å»¶è¿Ÿè®¾ç½®gameStartedï¼Œç¡®ä¿gridå·²æ›´æ–°
				setTimeout(() => {
					this.gameStarted = true
					this.startTime = Date.now()
					this.startTimer()
				}, 100)
			},
			restartGame() {
				this.startGame()
			},
			handleCellClick(cell: GridCell) {
				if (this.gameFinished || cell.clicked) {
					return
				}
				
				if (cell.number === this.currentNumber) {
					cell.clicked = true
					this.currentNumber++
					
					// æ£€æŸ¥æ˜¯å¦å®Œæˆ
					if (this.currentNumber > this.totalNumbers) {
						this.finishGame()
					}
				} else {
					// ç‚¹å‡»é”™è¯¯ï¼Œæç¤º
					uni.showToast({
						title: 'é¡ºåºä¸å¯¹å“¦ï¼Œç»§ç»­åŠ æ²¹ï¼',
						icon: 'none',
						duration: 1000
					})
				}
			},
			finishGame() {
				this.gameFinished = true
				this.stopTimer()
				uni.showToast({
					title: 'å¤ªæ£’äº†ï¼å®Œæˆæ¸¸æˆï¼',
					icon: 'success',
					duration: 2000
				})
			},
			startTimer() {
				// å…ˆæ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
				this.stopTimer()
				// åˆ›å»ºæ–°çš„å®šæ—¶å™¨
				const timerId = setInterval(() => {
					// æ£€æŸ¥æ¸¸æˆæ˜¯å¦è¿˜åœ¨è¿›è¡Œä¸­
					if (this.gameStarted && !this.gameFinished) {
						this.elapsedTime = Date.now() - this.startTime
					}
				}, 100)
				this.timer = timerId as number
			},
			stopTimer() {
				if (this.timer != 0) {
					try {
						clearInterval(this.timer)
					} catch (e) {
						// å¿½ç•¥æ¸…ç†é”™è¯¯
					}
					this.timer = 0
				}
			},
			formatTime(ms: number): string {
				const seconds = Math.floor(ms / 1000)
				const minutes = Math.floor(seconds / 60)
				const secs = seconds % 60
				const millis = Math.floor((ms % 1000) / 100)
				if (minutes > 0) {
					return `${minutes}åˆ†${secs}ç§’`
				}
				return `${secs}.${millis}ç§’`
			},
			goBack() {
				uni.navigateBack()
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #B8E6D4;
		padding: 10px;
		width: 100%;
	}
	
	.header {
		margin-top: 10px;
		margin-bottom: 10px;
	}
	
	.title {
		font-size: 28px;
		font-weight: bold;
		color: #FFFFFF;
		text-align: center;
		background-color: #4ECDC4;
		padding: 6px 12px;
		border-radius: 8px;
		border: 2px solid #FFFFFF;
	}
	
	.game-info-bar {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		background-color: #FFFFFF;
		border-radius: 12px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E0E0E0;
		padding: 10px 15px;
		margin-bottom: 10px;
		width: 100%;
	}
	
	.info-text {
		font-size: 18px;
		color: #4ECDC4;
		font-weight: bold;
		text-align: center;
		flex: 1;
	}
	
	.timer-text {
		font-size: 16px;
		color: #FF6B6B;
		font-weight: bold;
	}
	
	.current-text {
		font-size: 16px;
		color: #4ECDC4;
		font-weight: bold;
	}
	
	.result-text {
		font-size: 18px;
		color: #FF6B6B;
		font-weight: bold;
		text-align: center;
		flex: 1;
	}
	
	.grid-container {
		width: 100%;
		align-items: center;
		justify-content: center;
		margin: 10px 0;
		padding: 5px;
	}
	
	.grid-row {
		flex-direction: row;
		justify-content: center;
		align-items: center;
		margin-bottom: 4px;
		width: 100%;
	}
	
	.grid-cell {
		background-color: #FFD4B8;
		border-radius: 12px;
		border: 3px solid #FF6B6B;
		border-bottom-width: 6px;
		border-bottom-color: #E63946;
		margin: 2px;
		align-items: center;
		justify-content: center;
		position: relative;
	}
	
	.grid-cell:active {
		background-color: #FFC8A2;
		border-bottom-width: 3px;
	}
	
	.cell-number {
		font-weight: bold;
		color: #FF6B6B;
		text-align: center;
		line-height: 1;
	}
	
	.cell-clicked {
		background-color: #6A6A6A;
		border-color: #4A4A4A;
		opacity: 0.8;
	}
	
	.cell-clicked .cell-number {
		color: #CCCCCC;
		text-decoration: line-through;
	}
	
	.cell-current {
		background-color: #FFD4B8;
		border-color: #FF6B6B;
		border-width: 4px;
	}
	
	.cell-current .cell-number {
		color: #FF6B6B;
		font-size: 28px;
	}
	
	.button-container {
		margin-top: 15px;
		margin-bottom: 10px;
		width: 100%;
		align-items: center;
		justify-content: center;
		flex-direction: row;
		flex-wrap: wrap;
		padding: 5px;
	}
	
	.start-button {
		width: 180px;
		min-width: 160px;
		height: 50px;
		min-height: 45px;
		background-color: #FF6B6B;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #E63946;
		align-items: center;
		justify-content: center;
		margin: 5px;
	}
	
	.start-button:active {
		background-color: #FF5252;
		border-bottom-width: 3px;
	}
	
	.restart-button {
		width: 140px;
		height: 50px;
		background-color: #4ECDC4;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #3AB5AD;
		align-items: center;
		justify-content: center;
		margin: 5px;
	}
	
	.restart-button:active {
		background-color: #3AB5AD;
		border-bottom-width: 3px;
	}
	
	.back-button {
		width: 140px;
		height: 50px;
		background-color: #FFD4B8;
		border-radius: 15px;
		border: 3px solid #FFFFFF;
		border-bottom-width: 6px;
		border-bottom-color: #FFB88C;
		align-items: center;
		justify-content: center;
		margin: 5px;
	}
	
	.back-button:active {
		background-color: #FFB88C;
		border-bottom-width: 3px;
	}
	
	.button-text {
		font-size: 18px;
		font-weight: bold;
		color: #FFFFFF;
	}
</style>
