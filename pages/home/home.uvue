<template>
	<view class="container">
		<!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
		<view class="header">
			<text class="header-title">é¦–é¡µ</text>
			<view class="settings-button" @click="showSettingsDialog">
				<text class="settings-icon">âš™ï¸</text>
			</view>
		</view>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="content-scroll" scroll-y="true">
			<!-- æ‰“å¡æ—¥å† -->
			<view class="calendar-section">
				<view class="calendar-header">
					<view class="calendar-nav" @click="prevMonth">
						<text class="nav-arrow">â†</text>
					</view>
					<text class="calendar-month">{{ currentMonthText }}</text>
					<view 
						class="calendar-nav" 
						:class="{ 'calendar-nav-disabled': !canGoNextMonth }"
						@click="nextMonth"
					>
						<text class="nav-arrow">â†’</text>
					</view>
				</view>
				<view class="calendar-weekdays">
					<text class="weekday" v-for="day in weekdays" :key="day">{{ day }}</text>
				</view>
				<view class="calendar-days">
					<view 
						class="calendar-day" 
						v-for="(day, index) in calendarDays" 
						:key="index"
						:class="{ 
							'day-other-month': day.isOtherMonth,
							'day-today': day.isToday,
							'day-has-stamp': day.hasStamp
						}"
					>
						<text class="day-number">{{ day.date }}</text>
						<view class="stamp-icons" v-if="day.hasStamp">
							<text class="stamp-icon child-stamp" v-if="day.childStamped">ğŸ¾</text>
							<text class="stamp-icon parent-stamp" v-if="day.parentStamped">â¤ï¸</text>
						</view>
					</view>
				</view>
			</view>

			<!-- è§’è‰²åˆ‡æ¢æ ‡ç­¾ -->
			<view class="role-tabs">
				<view 
					class="role-tab" 
					:class="{ 'role-tab-active': currentRole === 'child' }"
					@click="switchRole('child')"
				>
					<text class="role-tab-text">å„¿ç«¥</text>
				</view>
				<view 
					class="role-tab" 
					:class="{ 'role-tab-active': currentRole === 'parent' }"
					@click="switchRole('parent')"
				>
					<text class="role-tab-text">å®¶é•¿</text>
				</view>
			</view>

			<!-- ä»»åŠ¡åˆ—è¡¨ -->
			<view class="task-list-section">
				<view 
					class="task-item" 
					v-for="task in currentTasks" 
					:key="task.id"
				>
					<text class="task-name">{{ task.item_name }}</text>
					<view v-if="task.completed" class="task-completed-stamp">
						<text class="stamp-text">å·²å®Œæˆ</text>
					</view>
					<view v-else-if="formatTaskProgress(task)" class="task-progress-wrap">
						<text class="task-progress-text">{{ formatTaskProgress(task) }}</text>
						<view class="task-action task-action-small" @click="goToCompleteTask(task)">
							<text class="complete-button">ç»§ç»­</text>
						</view>
					</view>
					<view v-else class="task-action" @click="goToCompleteTask(task)">
						<text class="complete-button">å»å®Œæˆ</text>
					</view>
				</view>
				<view v-if="currentTasks.length === 0" class="empty-tasks">
					<text class="empty-text">æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆè®¾ç½®æ‰“å¡ç›®æ ‡</text>
				</view>
			</view>
		</scroll-view>

		<!-- æ‰“å¡ç›®æ ‡è®¾ç½®å¯¹è¯æ¡† -->
		<view class="dialog-mask" v-if="showSettings" @click="closeSettingsDialog">
			<view class="settings-dialog" @click.stop>
				<view class="dialog-header">
					<text class="dialog-title">ç›®æ ‡é¡¹è®¾ç½®</text>
					<view class="dialog-close" @click="closeSettingsDialog">
						<text class="close-icon">âœ•</text>
					</view>
				</view>
				<view class="dialog-content">
					<!-- æœç´¢æ¡† -->
					<view class="search-box">
						<input 
							class="search-input" 
							placeholder="æœç´¢ä»»åŠ¡..." 
							v-model="searchKeyword"
							@input="onSearchInput"
						/>
						<text class="search-icon">ğŸ”</text>
					</view>
					<!-- è§’è‰²åˆ‡æ¢ -->
					<view class="dialog-role-tabs">
						<view 
							class="dialog-role-tab" 
							:class="{ 'dialog-role-tab-active': settingsRole === 'child' }"
							@click="switchSettingsRole('child')"
						>
							<text class="dialog-role-tab-text">å„¿ç«¥</text>
						</view>
						<view 
							class="dialog-role-tab" 
							:class="{ 'dialog-role-tab-active': settingsRole === 'parent' }"
							@click="switchSettingsRole('parent')"
						>
							<text class="dialog-role-tab-text">å®¶é•¿</text>
						</view>
					</view>
					<!-- ä»»åŠ¡é€‰æ‹©ç½‘æ ¼ -->
					<scroll-view class="task-grid-scroll" scroll-y="true">
						<view class="task-grid">
							<view 
								class="task-card" 
								v-for="task in filteredAvailableTasks" 
								:key="task.id"
								@click="toggleTaskSelection(task)"
							>
								<view class="task-card-icon">
									<text class="task-card-emoji">{{ task.icon }}</text>
								</view>
								<text class="task-card-name">{{ task.item_name }}</text>
								<view class="task-card-check" v-if="isTaskSelected(task)">
									<text class="task-card-check-icon">âœ“</text>
								</view>
								<view class="task-card-uncheck" v-else>
									<text class="task-card-uncheck-icon">â—‹</text>
								</view>
							</view>
						</view>
					</scroll-view>
				</view>
				<!-- ç¡®è®¤æŒ‰é’® - ç§»åˆ°dialog-contentå¤–é¢ï¼Œå›ºå®šåœ¨åº•éƒ¨ -->
				<view class="dialog-actions">
					<view class="dialog-button confirm-button" @click="saveTaskSettings">
						<text class="dialog-button-text">ç¡®è®¤</text>
					</view>
				</view>
			</view>
		</view>

		<!-- æ‰“å¡ç¡®è®¤å¯¹è¯æ¡† -->
		<view class="dialog-mask" v-if="showStampDialog" @click="closeStampDialog">
			<view class="stamp-dialog" @click.stop>
				<view class="stamp-icon-large">
					<text class="stamp-emoji">ğŸ¾</text>
					<text class="stamp-date">{{ todayDateText }}</text>
				</view>
				<text class="stamp-message">æ­å–œä½ å®Œæˆä»Šæ—¥ç›®æ ‡</text>
				<view class="stamp-actions">
					<view class="stamp-button" @click="confirmStamp">
						<text class="stamp-button-text">ç›–ç« æ‰“å¡</text>
					</view>
					<view class="stamp-button cancel-button" @click="closeStampDialog">
						<text class="stamp-button-text">å–æ¶ˆ</text>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getTodoItems, getDailyTodos, batchCreateDailyTodo, completeDailyTodo, uncompleteDailyTodo, deleteDailyTodo } from '../../utils/api.uts'
	
	type TaskItem = {
		id: string
		item_name: string
		icon: string
		role: string // 'child' | 'parent' (ä¿ç•™ç”¨äºå…¼å®¹)
		item_type?: number // 1 = å„¿ç«¥ï¼Œ2 = å®¶é•¿
		path_url?: string // è·³è½¬è·¯å¾„
	}

	type TaskItemWithCompleted = {
		id: string
		item_name: string
		icon: string
		role: string
		path_url?: string
		completed: boolean
		// å·²å¼€å§‹æœªå®Œæˆæ—¶çš„è¿›åº¦ï¼ˆcompletion_type 2=æ¬¡æ•° 3=æ—¶é•¿ï¼‰
		progress_count?: number | null
		progress_duration_minutes?: number | null
		completion_type?: number | null
		completion_target?: number | null
		completion_unit?: string | null
	}

	type CalendarDay = {
		date: number
		isOtherMonth: boolean
		isToday: boolean
		hasStamp: boolean
		childStamped: boolean
		parentStamped: boolean
	}

	type DailyTask = {
		taskId: string
		completed: boolean
		progress_count?: number | null
		progress_duration_minutes?: number | null
		completion_type?: number | null
		completion_target?: number | null
		completion_unit?: string | null
	}

	type DailyRecord = {
		date: string // YYYY-MM-DD
		childTasks: DailyTask[]
		parentTasks: DailyTask[]
		childStamped: boolean
		parentStamped: boolean
	}

	type TodayTasks = {
		childTasks: DailyTask[]
		parentTasks: DailyTask[]
	}

	type MapEntry = {
		key: string
		value: DailyRecord
	}

	export default {
		data() {
			return {
				currentRole: 'child', // 'child' | 'parent'
				currentYear: 0,
				currentMonth: 0,
				calendarDays: [] as CalendarDay[],
				weekdays: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
				showSettings: false,
				settingsRole: 'child',
				searchKeyword: '',
				showStampDialog: false,
				// æ‰€æœ‰å¯ç”¨ä»»åŠ¡
				allTasks: [] as TaskItem[],
				// å½“å‰é€‰ä¸­çš„ä»»åŠ¡ï¼ˆè®¾ç½®ä¸­ï¼‰
				selectedTaskIds: [] as string[],
				// ä»Šæ—¥ä»»åŠ¡è®°å½•
				todayTasks: {
					childTasks: [] as DailyTask[],
					parentTasks: [] as DailyTask[]
				} as TodayTasks,
				// ä»Šæ—¥æ¯æ—¥å¾…åŠåŸå§‹åˆ—è¡¨ï¼ˆå« idï¼Œç”¨äºäº‹é¡¹è·³è½¬ä¼  todoIdï¼‰
				todayDailyTodos: {
					child: [] as any[],
					parent: [] as any[]
				},
				// æ‰“å¡è®°å½•
				stampRecords: new Map<string, DailyRecord>()
			}
		},
		onLoad() {
			this.initData()
		},
		onShow() {
			// æ¯æ¬¡æ˜¾ç¤ºé¡µé¢æ—¶åˆ·æ–°ä»Šæ—¥ä»»åŠ¡çŠ¶æ€
			this.loadTodayTasks()
			
			// æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡éœ€è¦æ ‡è®°ä¸ºå®Œæˆï¼ˆä»æ¸¸æˆé¡µé¢è¿”å›æ—¶ï¼‰
			this.checkAndMarkTaskCompleted()
			
			// æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
			this.checkAllTasksCompleted()
		},
		computed: {
			currentMonthText(): string {
				const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ']
				return months[this.currentMonth]
			},
			canGoNextMonth(): boolean {
				const now = new Date()
				const currentYear = now.getFullYear()
				const currentMonth = now.getMonth()
				
				// å¦‚æœå½“å‰æ˜¾ç¤ºçš„æœˆä»½å·²ç»æ˜¯å½“å‰æœˆä»½æˆ–æ›´æ—©ï¼Œåˆ™ä¸èƒ½ç»§ç»­å‰è¿›
				if (this.currentYear > currentYear) {
					return false
				}
				if (this.currentYear === currentYear && this.currentMonth >= currentMonth) {
					return false
				}
				return true
			},
			currentTasks(): TaskItemWithCompleted[] {
				const roleTasks = this.currentRole === 'child' ? this.todayTasks.childTasks : this.todayTasks.parentTasks
				const result: TaskItemWithCompleted[] = []
				for (const dt of roleTasks) {
					const task = this.allTasks.find(t => t.id === dt.taskId)
					if (task != null && task.item_name != null) {
						result.push({
							id: task.id,
							item_name: task.item_name,
							icon: task.icon != null ? task.icon : 'ğŸ“‹',
							role: task.role,
							path_url: task.path_url,
							completed: dt.completed,
							progress_count: dt.progress_count,
							progress_duration_minutes: dt.progress_duration_minutes,
							completion_type: dt.completion_type,
							completion_target: dt.completion_target,
							completion_unit: dt.completion_unit
						})
					}
				}
				return result
			},
			availableTasks(): TaskItem[] {
				// æ ¹æ® item_type è¿‡æ»¤ï¼šitem_type=1 æ˜¾ç¤ºåœ¨å„¿ç«¥æ ‡ç­¾ä¸‹ï¼Œitem_type=2 æ˜¾ç¤ºåœ¨å®¶é•¿æ ‡ç­¾ä¸‹
				if (this.settingsRole === 'child') {
					return this.allTasks.filter(t => t.item_type === 1)
				} else {
					return this.allTasks.filter(t => t.item_type === 2)
				}
			},
			filteredAvailableTasks(): TaskItem[] {
				if (this.searchKeyword.trim() === '') {
					return this.availableTasks
				}
				const keyword = this.searchKeyword.toLowerCase()
				return this.availableTasks.filter(t => t.item_name != null && t.item_name.toLowerCase().includes(keyword))
			},
			todayDateText(): string {
				const now = new Date()
				return `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`
			}
		},
		methods: {
			// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ•°å­—ä¸ºæŒ‡å®šä½æ•°çš„å­—ç¬¦ä¸²
			padNumber(num: number, length: number): string {
				let str = num.toString()
				while (str.length < length) {
					str = '0' + str
				}
				return str
			},
			// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD æ ¼å¼
			formatDateKey(year: number, month: number, date: number): string {
				return `${year}-${this.padNumber(month, 2)}-${this.padNumber(date, 2)}`
			},
			// è¾…åŠ©å‡½æ•°ï¼šè·å–æ‰“å¡è®°å½•
			getStampRecord(dateKey: string): DailyRecord | null {
				if (this.stampRecords.has(dateKey)) {
					return this.stampRecords.get(dateKey) as DailyRecord
				}
				return null
			},
			// è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®æ‰“å¡è®°å½•
			setStampRecord(dateKey: string, record: DailyRecord) {
				this.stampRecords.set(dateKey, record)
			},
			initData() {
				// åˆå§‹åŒ–æ—¥æœŸ
				const now = new Date()
				this.currentYear = now.getFullYear()
				this.currentMonth = now.getMonth()

				// ä»APIåŠ è½½äº‹é¡¹å­—å…¸åˆ—è¡¨
				this.loadTodoItems()
				
				// åŠ è½½æ•°æ®
				this.loadTaskSettings()
				this.loadTodayTasks()
				this.loadStampRecords()
				this.updateCalendar()
			},
			// ä»APIåŠ è½½äº‹é¡¹å­—å…¸åˆ—è¡¨
			loadTodoItems() {
				// åŠ è½½æ‰€æœ‰äº‹é¡¹ï¼ˆä¸ä¼  role å‚æ•°è·å–å…¨éƒ¨ï¼‰
				getTodoItems(null, (result) => {
					if (result.success && result.data != null) {
						const allTasksList: TaskItem[] = []
						for (let i = 0; i < result.data.length; i++) {
							const item = result.data[i]
							// ä¼˜å…ˆä½¿ç”¨ item_nameï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ nameï¼Œéƒ½æ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
							const itemName = (item.item_name != null && item.item_name !== '') 
								? item.item_name 
								: (item.name != null && item.name !== '') 
									? item.name 
									: `ä»»åŠ¡${item.id}`
							
							// æ ¹æ® item_type ç¡®å®š roleï¼ˆç”¨äºå…¼å®¹ï¼‰
							const itemType = item.item_type != null ? item.item_type : (item.role === 'parent' ? 2 : 1)
							const role = itemType === 2 ? 'parent' : 'child'
							
							allTasksList.push({
								id: item.id.toString(),
								item_name: itemName,
								icon: item.icon != null && item.icon !== '' ? item.icon : 'ğŸ“‹',
								role: role,
								item_type: itemType,
								path_url: item.path_url != null && item.path_url !== '' ? item.path_url : undefined
							})
						}
						
						this.allTasks = allTasksList
						
						// å¦‚æœAPIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®ä½œä¸ºåå¤‡
						if (this.allTasks.length === 0) {
							this.allTasks = [
								{ id: 'schulte', item_name: 'èˆ’å°”ç‰¹æ–¹æ ¼', icon: 'ğŸ§©', role: 'child', item_type: 1, path_url: '/pages/game/detail/schulte-detail' },
								{ id: 'numhearing', item_name: 'å¬éŸ³è®°æ•°', icon: 'ğŸ§', role: 'child', item_type: 1, path_url: '/pages/game/detail/numhearing-detail' },
								{ id: 'jump-rope', item_name: 'è·³ç»³', icon: 'ğŸƒ', role: 'child', item_type: 1 },
								{ id: 'reading', item_name: 'é˜…è¯»', icon: 'ğŸ“–', role: 'child', item_type: 1 },
								{ id: 'training-game', item_name: 'è®­ç»ƒæ¸¸æˆ', icon: 'ğŸ®', role: 'child', item_type: 1 },
								{ id: 'meditation', item_name: 'å†¥æƒ³æ¸¸æˆ', icon: 'ğŸ”¤', role: 'child', item_type: 1, path_url: '/pages/game/detail/meditation-detail' },
								{ id: 'shape', item_name: 'å½¢çŠ¶è¯†åˆ«', icon: 'â­', role: 'child', item_type: 1, path_url: '/pages/game/detail/shape-detail' },
								{ id: 'memory', item_name: 'è®°å¿†æŒ‘æˆ˜', icon: 'ğŸ§ ', role: 'child', item_type: 1, path_url: '/pages/game/detail/memory-detail' },
								{ id: 'music', item_name: 'éŸ³ä¹èŠ‚å¥', icon: 'ğŸµ', role: 'child', item_type: 1, path_url: '/pages/game/detail/music-detail' },
								{ id: 'love-letter', item_name: 'äº²å­çˆ±å¿ƒä¿¡', icon: 'ğŸ’Œ', role: 'parent', item_type: 2, path_url: '/pages/mine/love-letter' },
								{ id: 'merit-book', item_name: 'åŠŸåŠ³ç°¿', icon: 'ğŸ“', role: 'parent', item_type: 2 }
							]
						}
						
						// é‡æ–°åŠ è½½ä»»åŠ¡è®¾ç½®å’Œä»Šæ—¥ä»»åŠ¡
						this.loadTaskSettings()
						this.loadTodayTasks()
					} else {
						// å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
						this.loadDefaultTasks()
					}
				})
			},
			// åŠ è½½é»˜è®¤ä»»åŠ¡æ•°æ®ï¼ˆä½œä¸ºåå¤‡ï¼‰
			loadDefaultTasks() {
				this.allTasks = [
					{ id: 'schulte', item_name: 'èˆ’å°”ç‰¹æ–¹æ ¼', icon: 'ğŸ§©', role: 'child', item_type: 1, path_url: '/pages/game/detail/schulte-detail' },
					{ id: 'numhearing', item_name: 'å¬éŸ³è®°æ•°', icon: 'ğŸ§', role: 'child', item_type: 1, path_url: '/pages/game/detail/numhearing-detail' },
					{ id: 'jump-rope', item_name: 'è·³ç»³', icon: 'ğŸƒ', role: 'child', item_type: 1 },
					{ id: 'reading', item_name: 'é˜…è¯»', icon: 'ğŸ“–', role: 'child', item_type: 1 },
					{ id: 'training-game', item_name: 'è®­ç»ƒæ¸¸æˆ', icon: 'ğŸ®', role: 'child', item_type: 1 },
					{ id: 'meditation', item_name: 'å†¥æƒ³æ¸¸æˆ', icon: 'ğŸ”¤', role: 'child', item_type: 1, path_url: '/pages/game/detail/meditation-detail' },
					{ id: 'shape', item_name: 'å½¢çŠ¶è¯†åˆ«', icon: 'â­', role: 'child', item_type: 1, path_url: '/pages/game/detail/shape-detail' },
					{ id: 'memory', item_name: 'è®°å¿†æŒ‘æˆ˜', icon: 'ğŸ§ ', role: 'child', item_type: 1, path_url: '/pages/game/detail/memory-detail' },
					{ id: 'music', item_name: 'éŸ³ä¹èŠ‚å¥', icon: 'ğŸµ', role: 'child', item_type: 1, path_url: '/pages/game/detail/music-detail' },
					{ id: 'love-letter', item_name: 'äº²å­çˆ±å¿ƒä¿¡', icon: 'ğŸ’Œ', role: 'parent', item_type: 2, path_url: '/pages/mine/love-letter' },
					{ id: 'merit-book', item_name: 'åŠŸåŠ³ç°¿', icon: 'ğŸ“', role: 'parent', item_type: 2 }
				]
			},
			updateCalendar() {
				const days: CalendarDay[] = []
				const firstDay = new Date(this.currentYear, this.currentMonth, 1)
				const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0)
				const firstDayOfWeek = firstDay.getDay()
				const today = new Date()
				const isCurrentMonth = today.getFullYear() === this.currentYear && today.getMonth() === this.currentMonth

				// ä¸Šä¸ªæœˆçš„æ—¥æœŸ
				const prevMonthLastDay = new Date(this.currentYear, this.currentMonth, 0).getDate()
				for (let i = firstDayOfWeek - 1; i >= 0; i--) {
					days.push({
						date: prevMonthLastDay - i,
						isOtherMonth: true,
						isToday: false,
						hasStamp: false,
						childStamped: false,
						parentStamped: false
					})
				}

				// å½“å‰æœˆçš„æ—¥æœŸ
				for (let date = 1; date <= lastDay.getDate(); date++) {
					const isToday = isCurrentMonth && date === today.getDate()
					const dateKey = this.formatDateKey(this.currentYear, this.currentMonth + 1, date)
					const record = this.getStampRecord(dateKey)
					
					days.push({
						date: date,
						isOtherMonth: false,
						isToday: isToday,
						hasStamp: record != null && (record.childStamped || record.parentStamped),
						childStamped: record != null && record.childStamped,
						parentStamped: record != null && record.parentStamped
					})
				}

				// ä¸‹ä¸ªæœˆçš„æ—¥æœŸï¼ˆå¡«æ»¡6è¡Œï¼‰
				const remainingDays = 42 - days.length
				for (let date = 1; date <= remainingDays; date++) {
					days.push({
						date: date,
						isOtherMonth: true,
						isToday: false,
						hasStamp: false,
						childStamped: false,
						parentStamped: false
					})
				}

				this.calendarDays = days
			},
			prevMonth() {
				if (this.currentMonth === 0) {
					this.currentMonth = 11
					this.currentYear--
				} else {
					this.currentMonth--
				}
				this.updateCalendar()
			},
			nextMonth() {
				// æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœˆ
				if (!this.canGoNextMonth) {
					return
				}
				
				if (this.currentMonth === 11) {
					this.currentMonth = 0
					this.currentYear++
				} else {
					this.currentMonth++
				}
				this.updateCalendar()
			},
			switchRole(role: string) {
				this.currentRole = role
				this.loadTodayTasks()
			},
			showSettingsDialog() {
				this.showSettings = true
				this.settingsRole = this.currentRole
				// é‡æ–°åŠ è½½ä»»åŠ¡å­—å…¸ï¼Œç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
				this.loadTodoItems()
				// åŠ è½½å·²é€‰ä¸­çš„ä»»åŠ¡è®¾ç½®
				this.loadTaskSettings()
			},
			closeSettingsDialog() {
				this.showSettings = false
				this.searchKeyword = ''
			},
			switchSettingsRole(role: string) {
				this.settingsRole = role
				this.loadTaskSettings()
			},
			// è·å–å½“å‰å­©å­IDï¼ˆä»æœ¬åœ°å­˜å‚¨ï¼Œä¸"æˆ‘çš„"é¡µé¢ä¿æŒä¸€è‡´ï¼‰
			getCurrentChildId(): string | null {
				try {
					// ä¼˜å…ˆä» currentChildId é”®è·å–ï¼ˆä¸ mine.uvue ä¸­çš„ saveCurrentChild ä¿æŒä¸€è‡´ï¼‰
					const currentChildId = uni.getStorageSync('currentChildId')
					if (currentChildId != null && currentChildId !== '') {
						return currentChildId.toString()
					}
					// å¦‚æœ currentChildId ä¸å­˜åœ¨ï¼Œå°è¯•ä» currentChild å¯¹è±¡è·å–ï¼ˆå‘åå…¼å®¹ï¼‰
					const currentChildStr = uni.getStorageSync('currentChild')
					if (currentChildStr != null && currentChildStr !== '') {
						const currentChild = JSON.parse(currentChildStr.toString())
						if (currentChild != null && currentChild.id != null) {
							return currentChild.id.toString()
						}
					}
				} catch (e) {
					console.error('è·å–å½“å‰å­©å­IDå¤±è´¥:', e)
				}
				return null
			},
			loadTaskSettings() {
				// ä»APIè·å–ä»Šæ—¥å·²é€‰ä¸­çš„äº‹é¡¹
				const today = new Date()
				const todoDate = this.formatDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate())
				const childId = this.settingsRole === 'child' ? this.getCurrentChildId() : null
				
				getDailyTodos({
					todo_date: todoDate,
					child_id: childId,
					status: 1 // åªè·å–æœ‰æ•ˆçš„å¾…åŠäº‹é¡¹
				}, (result) => {
					if (result.success && result.data != null) {
						// æå–å·²é€‰ä¸­çš„item_idåˆ—è¡¨ï¼Œå¹¶æ›´æ–°ä»»åŠ¡åç§°
						const selectedIds: string[] = []
						for (let i = 0; i < result.data.length; i++) {
							const todo = result.data[i]
							if (todo.item_id != null) {
								const itemIdStr = todo.item_id.toString()
								selectedIds.push(itemIdStr)
								
								// å¦‚æœæœåŠ¡å™¨è¿”å›äº† item_nameï¼Œæ›´æ–° allTasks ä¸­å¯¹åº”ä»»åŠ¡çš„åç§°
								if (todo.item_name != null && todo.item_name !== '') {
									const taskIndex = this.allTasks.findIndex(t => t.id === itemIdStr)
									if (taskIndex >= 0) {
										this.allTasks[taskIndex].item_name = todo.item_name
										// å¦‚æœæœåŠ¡å™¨è¿”å›äº† item_typeï¼Œä¹Ÿæ›´æ–°å®ƒ
										if (todo.item_type != null) {
											this.allTasks[taskIndex].item_type = todo.item_type
										}
									} else {
										// å¦‚æœä»»åŠ¡ä¸å­˜åœ¨äº allTasks ä¸­ï¼Œæ·»åŠ å®ƒ
										// æ ¹æ® settingsRole ç¡®å®š item_typeï¼šchild -> 1, parent -> 2
										const itemType = this.settingsRole === 'child' ? 1 : 2
										this.allTasks.push({
											id: itemIdStr,
											item_name: todo.item_name,
											icon: 'ğŸ“‹',
											role: this.settingsRole,
											item_type: todo.item_type != null ? todo.item_type : itemType,
											path_url: undefined
										})
									}
								}
							}
						}
						this.selectedTaskIds = selectedIds
					} else {
						// å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå‘åå…¼å®¹ï¼‰
						try {
							const key = `taskSettings_${this.settingsRole}`
							const saved = uni.getStorageSync(key)
							if (saved != null && saved !== "") {
								this.selectedTaskIds = JSON.parse(saved.toString()) as string[]
							} else {
								this.selectedTaskIds = []
							}
						} catch (e) {
							this.selectedTaskIds = []
						}
					}
				})
			},
			isTaskSelected(task: TaskItem): boolean {
				return this.selectedTaskIds.includes(task.id)
			},
			toggleTaskSelection(task: TaskItem) {
				const index = this.selectedTaskIds.indexOf(task.id)
				if (index >= 0) {
					// å–æ¶ˆé€‰æ‹©
					this.selectedTaskIds.splice(index, 1)
				} else {
					// é€‰æ‹©
					this.selectedTaskIds.push(task.id)
				}
			},
			saveTaskSettings() {
				const today = new Date()
				const todoDate = this.formatDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate())
				// è·å–å½“å‰å­©å­IDï¼Œç¡®ä¿ç±»å‹æ­£ç¡®
				let childId: string | number | null = null
				if (this.settingsRole === 'child') {
					const childIdStr = this.getCurrentChildId()
					if (childIdStr != null && childIdStr !== '') {
						// å°è¯•è½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å­—ç¬¦ä¸²
						const childIdNum = Number(childIdStr)
						childId = isNaN(childIdNum) ? childIdStr : childIdNum
					} else {
						// å¦‚æœ child_id ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·å…ˆé€‰æ‹©å­©å­
						uni.showToast({
							title: 'è¯·å…ˆåœ¨"æˆ‘çš„"é¡µé¢é€‰æ‹©å­©å­',
							icon: 'none',
							duration: 2000
						})
						return
					}
				}
				
				// è°ƒè¯•æ—¥å¿—
				console.log('saveTaskSettings - settingsRole:', this.settingsRole, 'childId:', childId)
				
				// å…ˆè·å–ä»Šæ—¥å·²æœ‰çš„å¾…åŠäº‹é¡¹ï¼Œä»¥ä¾¿åˆ é™¤æœªé€‰ä¸­çš„
				getDailyTodos({
					todo_date: todoDate,
					child_id: childId,
					status: 1
				}, (getResult) => {
					// æ„å»ºè¦åˆ›å»ºçš„å¾…åŠäº‹é¡¹åˆ—è¡¨å’Œè¦åˆ é™¤çš„å¾…åŠäº‹é¡¹åˆ—è¡¨
					const todosToCreate: any[] = []
					const todosToDelete: any[] = []
					
					// è·å–å·²å­˜åœ¨çš„å¾…åŠäº‹é¡¹
					const existingTodos: any[] = getResult.success && getResult.data != null ? getResult.data : []
					
					// 1. æ‰¾å‡ºéœ€è¦åˆ›å»ºçš„å¾…åŠäº‹é¡¹ï¼ˆå·²é€‰ä¸­ä½†ä¸å­˜åœ¨ï¼‰
					for (let i = 0; i < this.selectedTaskIds.length; i++) {
						const itemId = this.selectedTaskIds[i]
						// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
						let exists = false
						for (let j = 0; j < existingTodos.length; j++) {
							if (existingTodos[j].item_id != null && existingTodos[j].item_id.toString() === itemId) {
								exists = true
								break
							}
						}
						// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ åˆ°åˆ›å»ºåˆ—è¡¨
						if (!exists) {
							// ç¡®ä¿ item_id ç±»å‹æ­£ç¡®ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰
							const itemIdValue: string | number = (() => {
								const num = Number(itemId)
								return isNaN(num) ? itemId : num
							})()
							
							todosToCreate.push({
								item_id: itemIdValue,
								todo_date: todoDate,
								child_id: childId, // ç¡®ä¿ child_id è¢«æ­£ç¡®ä¼ é€’
								status: 1
							})
							
							// è°ƒè¯•æ—¥å¿—
							console.log('åˆ›å»ºå¾…åŠäº‹é¡¹:', {
								item_id: itemIdValue,
								todo_date: todoDate,
								child_id: childId
							})
						}
					}
					
					// 2. æ‰¾å‡ºéœ€è¦åˆ é™¤çš„å¾…åŠäº‹é¡¹ï¼ˆå·²å­˜åœ¨ä½†æœªé€‰ä¸­ï¼‰
					for (let i = 0; i < existingTodos.length; i++) {
						const todo = existingTodos[i]
						if (todo.item_id != null) {
							const itemIdStr = todo.item_id.toString()
							// æ£€æŸ¥æ˜¯å¦åœ¨é€‰ä¸­åˆ—è¡¨ä¸­
							const isSelected = this.selectedTaskIds.includes(itemIdStr)
							if (!isSelected && todo.id != null) {
								// æœªé€‰ä¸­ï¼Œéœ€è¦åˆ é™¤
								todosToDelete.push(todo.id)
								console.log('åˆ é™¤å¾…åŠäº‹é¡¹:', {
									id: todo.id,
									item_id: todo.item_id,
									item_name: todo.item_name
								})
							}
						}
					}
					
					// 3. æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆå…ˆåˆ é™¤ï¼Œå†åˆ›å»ºï¼‰
					let deleteCount = 0
					const totalOperations = todosToDelete.length + todosToCreate.length
					
					if (totalOperations === 0) {
						// æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥æ›´æ–°
						this.loadTaskSettings() // é‡æ–°åŠ è½½ä»»åŠ¡è®¾ç½®
						this.loadTodayTasks() // æ›´æ–°ä»Šæ—¥ä»»åŠ¡
						
						uni.showToast({
							title: 'è®¾ç½®æˆåŠŸ',
							icon: 'success'
						})
						
						this.closeSettingsDialog()
						
						// åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä½œä¸ºåå¤‡ï¼‰
						try {
							const key = `taskSettings_${this.settingsRole}`
							uni.setStorageSync(key, JSON.stringify(this.selectedTaskIds))
						} catch (e) {
							// å¿½ç•¥æœ¬åœ°å­˜å‚¨é”™è¯¯
						}
						return
					}
					
					// åˆ é™¤æœªé€‰ä¸­çš„å¾…åŠäº‹é¡¹
					const deleteNext = () => {
						if (deleteCount < todosToDelete.length) {
							const todoId = todosToDelete[deleteCount]
							deleteDailyTodo(todoId, (deleteResult) => {
								deleteCount++
								if (deleteResult.success) {
									// ç»§ç»­åˆ é™¤ä¸‹ä¸€ä¸ª
									deleteNext()
								} else {
									console.error('åˆ é™¤å¾…åŠäº‹é¡¹å¤±è´¥:', deleteResult.message)
									// å³ä½¿åˆ é™¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­å¤„ç†
									deleteNext()
								}
							})
						} else {
							// æ‰€æœ‰åˆ é™¤å®Œæˆï¼Œå¼€å§‹åˆ›å»º
							createNext()
						}
					}
					
					// åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹
					const createNext = () => {
						if (todosToCreate.length > 0) {
							// æ‰¹é‡åˆ›å»ºæ‰€æœ‰å¾…åˆ›å»ºçš„äº‹é¡¹
							batchCreateDailyTodo(todosToCreate, (createResult) => {
								if (createResult.success) {
									// æ‰€æœ‰æ“ä½œå®Œæˆï¼Œæ›´æ–°æ•°æ®
									this.loadTaskSettings() // é‡æ–°åŠ è½½ä»»åŠ¡è®¾ç½®ï¼Œæ›´æ–°é€‰ä¸­çŠ¶æ€
									this.loadTodayTasks() // æ›´æ–°ä»Šæ—¥ä»»åŠ¡
									
									uni.showToast({
										title: 'è®¾ç½®æˆåŠŸ',
										icon: 'success'
									})
									
									this.closeSettingsDialog()
									
									// åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä½œä¸ºåå¤‡ï¼‰
									try {
										const key = `taskSettings_${this.settingsRole}`
										uni.setStorageSync(key, JSON.stringify(this.selectedTaskIds))
									} catch (e) {
										// å¿½ç•¥æœ¬åœ°å­˜å‚¨é”™è¯¯
									}
								} else {
									uni.showToast({
										title: createResult.message || 'ä¿å­˜å¤±è´¥',
										icon: 'none'
									})
								}
							})
						} else {
							// æ²¡æœ‰éœ€è¦åˆ›å»ºçš„ï¼Œç›´æ¥æ›´æ–°
							this.loadTaskSettings() // é‡æ–°åŠ è½½ä»»åŠ¡è®¾ç½®
							this.loadTodayTasks() // æ›´æ–°ä»Šæ—¥ä»»åŠ¡
							
							uni.showToast({
								title: 'è®¾ç½®æˆåŠŸ',
								icon: 'success'
							})
							
							this.closeSettingsDialog()
							
							// åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä½œä¸ºåå¤‡ï¼‰
							try {
								const key = `taskSettings_${this.settingsRole}`
								uni.setStorageSync(key, JSON.stringify(this.selectedTaskIds))
							} catch (e) {
								// å¿½ç•¥æœ¬åœ°å­˜å‚¨é”™è¯¯
							}
						}
					}
					
					// å¼€å§‹æ‰§è¡Œåˆ é™¤æ“ä½œ
					if (todosToDelete.length > 0) {
						deleteNext()
					} else {
						// æ²¡æœ‰éœ€è¦åˆ é™¤çš„ï¼Œç›´æ¥åˆ›å»º
						createNext()
					}
				})
			},
			loadTodayTasks() {
				const today = new Date()
				const dateKey = this.formatDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate())
				const childId = this.getCurrentChildId()
				
				// ä»APIåŠ è½½å­©å­äº‹é¡¹
				getDailyTodos({
					todo_date: dateKey,
					child_id: childId,
					status: 1
				}, (childResult) => {
					const childTasks: DailyTask[] = []
					if (childResult.success && childResult.data != null) {
						this.todayDailyTodos.child = childResult.data
						for (let i = 0; i < childResult.data.length; i++) {
							const todo = childResult.data[i]
							if (todo.item_id != null) {
								childTasks.push({
									taskId: todo.item_id.toString(),
									completed: todo.completed === true || (todo as any).is_completed === true || (todo as any).is_completed === 1,
									progress_count: todo.progress_count,
									progress_duration_minutes: todo.progress_duration_minutes,
									completion_type: todo.completion_type,
									completion_target: todo.completion_target,
									completion_unit: todo.completion_unit
								})
							}
						}
					} else {
						this.todayDailyTodos.child = []
					}
					this.todayTasks.childTasks = childTasks
					
					// ä»APIåŠ è½½å®¶é•¿äº‹é¡¹ï¼ˆchild_idä¸ºnullï¼‰
					getDailyTodos({
						todo_date: dateKey,
						child_id: null,
						status: 1
					}, (parentResult) => {
						const parentTasks: DailyTask[] = []
						if (parentResult.success && parentResult.data != null) {
							this.todayDailyTodos.parent = parentResult.data
							for (let i = 0; i < parentResult.data.length; i++) {
								const todo = parentResult.data[i]
								if (todo.item_id != null) {
									parentTasks.push({
										taskId: todo.item_id.toString(),
										completed: todo.completed === true || (todo as any).is_completed === true || (todo as any).is_completed === 1,
										progress_count: todo.progress_count,
										progress_duration_minutes: todo.progress_duration_minutes,
										completion_type: todo.completion_type,
										completion_target: todo.completion_target,
										completion_unit: todo.completion_unit
									})
								}
							}
						} else {
							this.todayDailyTodos.parent = []
						}
						this.todayTasks.parentTasks = parentTasks
						
						// æ›´æ–°æ—¥å†æ˜¾ç¤º
						this.updateCalendar()
					})
				})
			},
			getTaskSettings(role: string): string[] {
				try {
					const key = `taskSettings_${role}`
					const saved = uni.getStorageSync(key)
					if (saved != null && saved != "") {
						return JSON.parse(saved.toString()) as string[]
					}
				} catch (e) {
					// å¿½ç•¥é”™è¯¯
				}
				return []
			},
			/** å·²å¼€å§‹æœªå®Œæˆæ—¶æ˜¾ç¤ºè¿›åº¦æ–‡æ¡ˆï¼Œå¦‚ "3/5 æ¬¡"ã€"20/30 åˆ†é’Ÿ"ï¼Œæ— è¿›åº¦è¿”å›ç©ºå­—ç¬¦ä¸² */
			formatTaskProgress(task: TaskItemWithCompleted): string {
				if (task.completed) return ''
				const type = task.completion_type != null ? task.completion_type : 1
				if (type === 2 && task.completion_target != null && task.completion_target > 0) {
					const n = task.progress_count != null ? task.progress_count : 0
					return `${n}/${task.completion_target} æ¬¡`
				}
				if (type === 3 && task.completion_target != null && task.completion_target > 0) {
					const n = task.progress_duration_minutes != null ? task.progress_duration_minutes : 0
					const unit = task.completion_unit === 'second' ? 'ç§’' : 'åˆ†é’Ÿ'
					return `${n}/${task.completion_target} ${unit}`
				}
				// type 1 æˆ– æ—  targetï¼šæœ‰æ‰“å¡è¿›åº¦ä¹Ÿæ˜¾ç¤ºï¼ˆå¦‚ progress_count > 0ï¼‰
				if ((task.progress_count != null && task.progress_count > 0) || (task.progress_duration_minutes != null && task.progress_duration_minutes > 0)) {
					if (task.progress_count != null && task.progress_count > 0 && task.completion_target != null) return `${task.progress_count}/${task.completion_target} æ¬¡`
					if (task.progress_duration_minutes != null && task.progress_duration_minutes > 0 && task.completion_target != null) {
						const u = task.completion_unit === 'second' ? 'ç§’' : 'åˆ†é’Ÿ'
						return `${task.progress_duration_minutes}/${task.completion_target} ${u}`
					}
					if (task.progress_count != null && task.progress_count > 0) return `${task.progress_count} æ¬¡`
					if (task.progress_duration_minutes != null && task.progress_duration_minutes > 0) return `${task.progress_duration_minutes} åˆ†é’Ÿ`
				}
				return ''
			},
			goToCompleteTask(task: TaskItemWithCompleted) {
				// ä¿å­˜å½“å‰ä»»åŠ¡IDï¼Œç”¨äºè¿”å›æ—¶æ ‡è®°å®Œæˆ
				try {
					uni.setStorageSync('currentTaskId', task.id)
					uni.setStorageSync('currentTaskRole', this.currentRole)
				} catch (e) {
					// å¿½ç•¥é”™è¯¯
				}
				
				if (task.path_url != null && task.path_url !== '') {
					let url = task.path_url
					// äº²å­çˆ±å¿ƒä¿¡ï¼šä»äº‹é¡¹è¿›å…¥éœ€ä¼  from=task&todoId&idï¼Œä»¥ä¾¿åªè¯»+å·²è¯»æŒ‰é’®
					if (task.path_url.indexOf('love-letter') >= 0) {
						const list = this.currentRole === 'child' ? this.todayDailyTodos.child : this.todayDailyTodos.parent
						let todoId = ''
						for (let i = 0; i < list.length; i++) {
							const todo = list[i]
							if (todo.item_id != null && todo.item_id.toString() === task.id) {
								if (todo.id != null) todoId = todo.id.toString()
								break
							}
						}
						const childId = this.getCurrentChildId() || ''
						const sep = task.path_url.indexOf('?') >= 0 ? '&' : '?'
						url = task.path_url + sep + 'from=task&todoId=' + encodeURIComponent(todoId) + '&id=' + encodeURIComponent(childId)
					}
					uni.navigateTo({
						url: url
					})
				} else {
					uni.showToast({
						title: 'åŠŸèƒ½å¼€å‘ä¸­',
						icon: 'none'
					})
				}
			},
			checkAllTasksCompleted() {
				const tasks = this.currentRole === 'child' ? this.todayTasks.childTasks : this.todayTasks.parentTasks
				if (tasks.length === 0) {
					return
				}
				
				const allCompleted = tasks.every(t => t.completed)
				if (allCompleted && !this.showStampDialog) {
					// æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æ‰“å¡
					const today = new Date()
					const dateKey = this.formatDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate())
					const record = this.getStampRecord(dateKey)
					
					const alreadyStamped = this.currentRole === 'child' 
						? (record != null && record.childStamped)
						: (record != null && record.parentStamped)
					
					if (!alreadyStamped) {
						this.showStampDialog = true
					}
				}
			},
			confirmStamp() {
				const today = new Date()
				const dateKey = this.formatDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate())
				
				// æ›´æ–°æ‰“å¡è®°å½•
				let record = this.getStampRecord(dateKey)
				if (record == null) {
					record = {
						date: dateKey,
						childTasks: this.todayTasks.childTasks,
						parentTasks: this.todayTasks.parentTasks,
						childStamped: false,
						parentStamped: false
					}
					this.setStampRecord(dateKey, record)
				}
				
				if (this.currentRole === 'child') {
					record.childStamped = true
					record.childTasks = this.todayTasks.childTasks
				} else {
					record.parentStamped = true
					record.parentTasks = this.todayTasks.parentTasks
				}
				
				// ä¿å­˜æ‰“å¡è®°å½•
				this.saveStampRecords()
				
				// æ›´æ–°æ—¥å†
				this.updateCalendar()
				
				uni.showToast({
					title: 'æ‰“å¡æˆåŠŸï¼',
					icon: 'success'
				})
				
				this.closeStampDialog()
			},
			closeStampDialog() {
				this.showStampDialog = false
			},
			loadStampRecords() 
			{
				try {
					const saved = uni.getStorageSync('stampRecords')
					if (saved != null && saved != "") 
					{
						const parsed = JSON.parse(saved.toString()) as any
						this.stampRecords.clear()
						
						// åˆ¤æ–­æ˜¯æ•°ç»„æ ¼å¼è¿˜æ˜¯å¯¹è±¡æ ¼å¼
						if (Array.isArray(parsed)) {
							// æ•°ç»„æ ¼å¼ï¼š[{key, value}, ...]
							for (let i = 0; i < parsed.length; i++) {
								const item = parsed[i] as MapEntry
								if (item != null && item.key != null && item.value != null) {
									this.stampRecords.set(item.key, item.value)
								}
							}
						} else {
							// å¯¹è±¡æ ¼å¼ï¼šç”±äº UTS ä¸æ”¯æŒ Object.keys å’Œæ–¹æ‹¬å·è®¿é—®
							// ç›´æ¥è·³è¿‡å¯¹è±¡æ ¼å¼ï¼Œåªæ”¯æŒæ•°ç»„æ ¼å¼
							// å¦‚æœæ•°æ®æ˜¯å¯¹è±¡æ ¼å¼ï¼Œä¼šåœ¨ä¸‹æ¬¡ä¿å­˜æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
						}
					}
				} 
				catch (e) 
				{
					this.stampRecords.clear()
				}
			},
			saveStampRecords() {
				try {
					// å°† Map è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ï¼Œç„¶ååºåˆ—åŒ–
					// ä½¿ç”¨ Map çš„ forEach æ–¹æ³•éå†
					const mapArray: MapEntry[] = []
					this.stampRecords.forEach((value, key) => {
						mapArray.push({
							key: key,
							value: value
						})
					})
					uni.setStorageSync('stampRecords', JSON.stringify(mapArray))
				} 
				catch (e) 
				{
					// å¿½ç•¥é”™è¯¯
				}
			},
			onSearchInput() {
				// æœç´¢åŠŸèƒ½å·²é€šè¿‡computedå®ç°
			},
			// æ£€æŸ¥å¹¶æ ‡è®°ä»»åŠ¡å®Œæˆï¼ˆä»æ¸¸æˆé¡µé¢è¿”å›æ—¶ï¼‰
			checkAndMarkTaskCompleted() {
				try {
					const taskId = uni.getStorageSync('currentTaskId')
					const taskRole = uni.getStorageSync('currentTaskRole')
					const taskCompleted = uni.getStorageSync('taskCompleted')
					
					if (taskId != null && taskId !== '' && taskCompleted === true) {
						// æ¸…é™¤æ ‡è®°
						uni.removeStorageSync('currentTaskId')
						uni.removeStorageSync('currentTaskRole')
						uni.removeStorageSync('taskCompleted')
						
						// æ ‡è®°ä»»åŠ¡å®Œæˆ
						this.markTaskCompleted(taskId.toString(), taskRole != null ? taskRole.toString() : this.currentRole)
					}
				} catch (e) {
					// å¿½ç•¥é”™è¯¯
				}
			},
			// æ ‡è®°ä»»åŠ¡å®Œæˆ
			markTaskCompleted(taskId: string, role: string) {
				const today = new Date()
				const dateKey = this.formatDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate())
				const childId = role === 'child' ? this.getCurrentChildId() : null
				
				// å…ˆæŸ¥æ‰¾å¯¹åº”çš„å¾…åŠäº‹é¡¹ID
				getDailyTodos({
					todo_date: dateKey,
					child_id: childId,
					status: 1
				}, (result) => {
					if (result.success && result.data != null) {
						// æŸ¥æ‰¾åŒ¹é…çš„å¾…åŠäº‹é¡¹
						let foundTodo: any = null
						for (let i = 0; i < result.data.length; i++) {
							const todo = result.data[i]
							if (todo.item_id != null && todo.item_id.toString() === taskId) {
								foundTodo = todo
								break
							}
						}
						
						if (foundTodo != null && foundTodo.id != null) {
							// è°ƒç”¨APIæ ‡è®°å®Œæˆ
							completeDailyTodo(foundTodo.id, (completeResult) => {
								if (completeResult.success) {
									// æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
									const tasks = role === 'child' ? this.todayTasks.childTasks : this.todayTasks.parentTasks
									const task = tasks.find(t => t.taskId === taskId)
									if (task != null) {
										task.completed = true
									} else {
										tasks.push({ taskId, completed: true })
									}
									
									// æ›´æ–°æ—¥å†æ˜¾ç¤º
									this.updateCalendar()
									
									// æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
									this.checkAllTasksCompleted()
								} else {
									uni.showToast({
										title: completeResult.message || 'æ ‡è®°å¤±è´¥',
										icon: 'none'
									})
								}
							})
						} else {
							// å¦‚æœæ‰¾ä¸åˆ°å¾…åŠäº‹é¡¹ï¼Œå¯èƒ½æ˜¯è¿˜æ²¡æœ‰åˆ›å»ºï¼Œå…ˆåˆ›å»ºå†æ ‡è®°å®Œæˆ
							const childIdForCreate = role === 'child' ? this.getCurrentChildId() : null
							batchCreateDailyTodo([{
								item_id: taskId,
								todo_date: dateKey,
								child_id: childIdForCreate,
								status: 1
							}], (createResult) => {
								if (createResult.success && createResult.data != null && createResult.data.length > 0) {
									const newTodo = createResult.data[0]
									if (newTodo.id != null) {
										// åˆ›å»ºæˆåŠŸåç«‹å³æ ‡è®°å®Œæˆ
										completeDailyTodo(newTodo.id, (completeResult) => {
											if (completeResult.success) {
												// æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
												const tasks = role === 'child' ? this.todayTasks.childTasks : this.todayTasks.parentTasks
												const task = tasks.find(t => t.taskId === taskId)
												if (task != null) {
													task.completed = true
												} else {
													tasks.push({ taskId, completed: true })
												}
												
												// æ›´æ–°æ—¥å†æ˜¾ç¤º
												this.updateCalendar()
												
												// æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
												this.checkAllTasksCompleted()
											}
										})
									}
								} else {
									uni.showToast({
										title: 'åˆ›å»ºå¾…åŠäº‹é¡¹å¤±è´¥',
										icon: 'none'
									})
								}
							})
						}
					} else {
						// APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡
						let record = this.getStampRecord(dateKey)
						if (record == null) {
							record = {
								date: dateKey,
								childTasks: this.todayTasks.childTasks,
								parentTasks: this.todayTasks.parentTasks,
								childStamped: false,
								parentStamped: false
							}
							this.setStampRecord(dateKey, record)
						}
						
						// æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€
						const tasks = role === 'child' ? record.childTasks : record.parentTasks
						const task = tasks.find(t => t.taskId === taskId)
						if (task != null) {
							task.completed = true
						} else {
							tasks.push({ taskId, completed: true })
						}
						
						// æ›´æ–°ä»Šæ—¥ä»»åŠ¡
						if (role === 'child') {
							this.todayTasks.childTasks = tasks
						} else {
							this.todayTasks.parentTasks = tasks
						}
						
						// ä¿å­˜è®°å½•
						this.saveStampRecords()
						this.updateCalendar()
						this.checkAllTasksCompleted()
					}
				})
			}
		}
	}
</script>

<style>
	.container {
		flex: 1;
		background-color: #F5F5F5;
	}
	
	/* é¡¶éƒ¨æ ‡é¢˜æ  */
	.header {
		height: 50px;
		background-color: #E0E0E0;
		flex-direction: row;
		align-items: center;
		justify-content: center;
		position: relative;
		padding: 0 15px;
	}

	.header-title {
		font-size: 18px;
		font-weight: bold;
		color: #333333;
	}

	.settings-button {
		position: absolute;
		right: 15px;
		width: 30px;
		height: 30px;
		align-items: center;
		justify-content: center;
	}

	.settings-icon {
		font-size: 20px;
	}

	.content-scroll {
		flex: 1;
	}

	/* æ—¥å†åŒºåŸŸ */
	.calendar-section {
		background-color: #FFFFFF;
		margin: 15px;
		border-radius: 12px;
		padding: 10px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		height: 200px;
		overflow: hidden;
	}

	.calendar-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 6px;
		height: 28px;
	}

	.calendar-nav {
		width: 24px;
		height: 24px;
		align-items: center;
		justify-content: center;
	}

	.calendar-nav-disabled {
		opacity: 0.3;
	}

	.calendar-nav-disabled:active {
		opacity: 0.3;
	}

	.nav-arrow {
		font-size: 14px;
		color: #666666;
	}

	.calendar-nav-disabled .nav-arrow {
		color: #CCCCCC;
	}

	.calendar-month {
		font-size: 14px;
		font-weight: bold;
		color: #333333;
	}

	.calendar-weekdays {
		flex-direction: row;
		margin-bottom: 4px;
		height: 18px;
	}

	.weekday {
		flex: 1;
		text-align: center;
		font-size: 10px;
		color: #999999;
		padding: 2px 0;
	}

	.calendar-days {
		flex-direction: row;
		flex-wrap: wrap;
		width: 100%;
	}

	.calendar-day {
		width: 14.14%;
		height: 24px;
		align-items: center;
		justify-content: center;
		position: relative;
		border-radius: 4px;
		margin-right: 0;
		margin-bottom: 2px;
		box-sizing: border-box;
	}

	.day-number {
		font-size: 11px;
		color: #333333;
	}

	.calendar-day.day-other-month .day-number {
		color: #CCCCCC;
	}

	.calendar-day.day-today {
		background-color: #4A90E2;
	}

	.calendar-day.day-today .day-number {
		color: #FFFFFF;
		font-weight: bold;
	}

	.stamp-icons {
		position: absolute;
		bottom: 0px;
		flex-direction: row;
		align-items: center;
		justify-content: center;
	}

	.stamp-icon {
		font-size: 7px;
		margin: 0 1px;
	}

	/* è§’è‰²åˆ‡æ¢æ ‡ç­¾ */
	.role-tabs {
		flex-direction: row;
		margin: 0 15px 15px 15px;
		background-color: #FFFFFF;
		border-radius: 12px;
		padding: 5px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.role-tab {
		flex: 1;
		align-items: center;
		justify-content: center;
		padding: 10px 0;
		border-radius: 8px;
	}

	.role-tab-active {
		background-color: #4A90E2;
	}

	.role-tab-text {
		font-size: 16px;
		color: #666666;
	}

	.role-tab-active .role-tab-text {
		color: #FFFFFF;
		font-weight: bold;
	}

	/* ä»»åŠ¡åˆ—è¡¨ */
	.task-list-section {
		background-color: #FFFFFF;
		margin: 0 15px 15px 15px;
		border-radius: 12px;
		padding: 15px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		overflow: visible;
	}

	.task-item {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		padding: 15px 14px 15px 0;
		border-bottom-width: 1px;
		border-bottom-color: #F0F0F0;
		border-bottom-style: solid;
		overflow: visible;
	}

	.task-item:last-child {
		border-bottom-width: 0;
	}

	.task-name {
		font-size: 16px;
		color: #333333;
		flex: 1;
	}

	/* å·²å®Œæˆï¼šå°ç« æ ·å¼ï¼ŒåŒè‰²å†…æ¡†+å¤–æ¡† */
	.task-completed-stamp {
		padding: 5px 10px;
		min-width: 72px;
		align-items: center;
		justify-content: center;
		background-color: transparent;
		border-width: 2px;
		border-color: #c41e3a;
		border-radius: 4px;
		transform: rotate(-10deg);
		box-shadow: 0 0 0 2px #c41e3a;
		flex-shrink: 0;
	}

	.stamp-text {
		font-size: 14px;
		color: #c41e3a;
		font-weight: bold;
		letter-spacing: 1px;
	}

	.task-action {
		padding: 6px 15px;
		background-color: #4CAF50;
		border-radius: 6px;
	}

	.task-action:active {
		background-color: #45A049;
		opacity: 0.8;
	}

	.task-action-small {
		padding: 4px 10px;
		margin-left: 8px;
	}

	.task-progress-wrap {
		flex-direction: row;
		align-items: center;
	}

	.task-progress-text {
		font-size: 13px;
		color: #666666;
	}

	.complete-button {
		font-size: 14px;
		color: #FFFFFF;
		font-weight: 400;
	}

	.empty-tasks {
		padding: 30px 0;
		align-items: center;
		justify-content: center;
	}

	.empty-text {
		font-size: 14px;
		color: #999999;
	}

	/* å¯¹è¯æ¡†é®ç½© */
	.dialog-mask {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0, 0, 0, 0.5);
		align-items: center;
		justify-content: center;
		z-index: 999;
	}

	/* è®¾ç½®å¯¹è¯æ¡† */
	.settings-dialog {
		width: 90%;
		max-width: 500px;
		height: 600px;
		background-color: #FFFFFF;
		border-radius: 16px;
		overflow: hidden;
		flex-direction: column;
	}

	.dialog-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		padding: 20px;
		border-bottom-width: 1px;
		border-bottom-color: #F0F0F0;
		border-bottom-style: solid;
	}
	
	.dialog-title {
		font-size: 18px;
		font-weight: bold;
		color: #333333;
	}

	.dialog-close {
		width: 30px;
		height: 30px;
		align-items: center;
		justify-content: center;
	}

	.close-icon {
		font-size: 20px;
		color: #999999;
	}

	.dialog-content {
		padding: 20px;
		flex: 1;
		flex-direction: column;
		overflow: hidden;
	}

	.search-box {
		flex-direction: row;
		align-items: center;
		background-color: #F5F5F5;
		border-radius: 8px;
		padding: 10px 15px;
		margin-bottom: 15px;
	}

	.search-input {
		flex: 1;
		font-size: 14px;
		color: #333333;
	}

	.search-icon {
		font-size: 16px;
		margin-left: 10px;
	}

	.dialog-role-tabs {
		flex-direction: row;
		margin-bottom: 15px;
		background-color: #F5F5F5;
		border-radius: 8px;
		padding: 4px;
	}

	.dialog-role-tab {
		flex: 1;
		align-items: center;
		justify-content: center;
		padding: 8px 0;
		border-radius: 6px;
	}

	.dialog-role-tab-active {
		background-color: #4A90E2;
	}

	.dialog-role-tab-text {
		font-size: 14px;
		color: #666666;
	}

	.dialog-role-tab-active .dialog-role-tab-text {
		color: #FFFFFF;
		font-weight: bold;
	}

	.task-grid-scroll {
		flex: 1;
		min-height: 0;
		height: 350px;
		margin-bottom: 0;
	}

	.task-grid {
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-between;
	}

	.task-card {
		width: 48%;
		background-color: #F9F9F9;
		border-radius: 12px;
		padding: 15px;
		margin-bottom: 12px;
		align-items: center;
		position: relative;
		border: 2px solid transparent;
	}

	.task-card:active {
		background-color: #F0F0F0;
	}

	.task-card-icon {
		width: 50px;
		height: 50px;
		background-color: #FFFFFF;
		border-radius: 10px;
		align-items: center;
		justify-content: center;
		margin-bottom: 10px;
	}

	.task-card-emoji {
		font-size: 28px;
	}

	.task-card-name {
		font-size: 14px;
		color: #333333;
		text-align: center;
	}
	
	.task-card-check {
		position: absolute;
		top: 8px;
		right: 8px;
		width: 24px;
		height: 24px;
		background-color: #4CAF50;
		border-radius: 12px;
		align-items: center;
		justify-content: center;
	}

	.task-card-check-icon {
		font-size: 14px;
		color: #FFFFFF;
		font-weight: bold;
	}

	.task-card-uncheck {
		position: absolute;
		top: 8px;
		right: 8px;
		width: 24px;
		height: 24px;
		border-width: 2px;
		border-color: #CCCCCC;
		border-radius: 12px;
		border-style: solid;
		align-items: center;
		justify-content: center;
	}

	.task-card-uncheck-icon {
		font-size: 12px;
		color: #CCCCCC;
	}

	.dialog-actions {
		padding: 15px 20px 20px 20px;
		border-top-width: 1px;
		border-top-color: #F0F0F0;
		border-top-style: solid;
		background-color: #FFFFFF;
		flex-shrink: 0;
	}

	.dialog-button {
		width: 100%;
		background-color: #4A90E2;
		border-radius: 8px;
		padding: 12px 0;
		align-items: center;
		justify-content: center;
	}

	.dialog-button:active {
		background-color: #3A7BC8;
	}

	.dialog-button-text {
		font-size: 16px;
		color: #FFFFFF;
		font-weight: bold;
	}

	/* æ‰“å¡ç¡®è®¤å¯¹è¯æ¡† */
	.stamp-dialog {
		width: 80%;
		max-width: 300px;
		background-color: #FFFFFF;
		border-radius: 16px;
		padding: 30px 20px;
		align-items: center;
	}

	.stamp-icon-large {
		align-items: center;
		justify-content: center;
		margin-bottom: 20px;
	}

	.stamp-emoji {
		font-size: 60px;
		margin-bottom: 10px;
	}

	.stamp-date {
		font-size: 14px;
		color: #666666;
	}

	.stamp-message {
		font-size: 18px;
		color: #333333;
		font-weight: bold;
		margin-bottom: 25px;
		text-align: center;
	}

	.stamp-actions {
		width: 100%;
		flex-direction: row;
		justify-content: space-between;
	}

	.stamp-button {
		flex: 1;
		background-color: #4CAF50;
		border-radius: 8px;
		padding: 12px 0;
		align-items: center;
		justify-content: center;
		margin: 0 5px;
	}

	.stamp-button:active {
		background-color: #45A049;
	}

	.cancel-button {
		background-color: #CCCCCC;
	}

	.cancel-button:active {
		background-color: #BBBBBB;
	}

	.stamp-button-text {
		font-size: 14px;
		color: #FFFFFF;
		font-weight: bold;
	}
</style>